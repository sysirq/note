# 前提知识

在 .NET 体系中，托管代码（Managed Code） 和 非托管代码（Unmanaged Code） 是一个非常核心、也很容易在逆向/安全分析中遇到的概念。

### 托管代码（Managed Code）

##### 定义

运行在 .NET CLR（Common Language Runtime）之上的代码

典型语言：

- C#
- VB.NET
- F#
- Managed C++（/clr）

编译产物：

- .exe / .dll（不是机器码）
- 内部是 IL（Intermediate Language，中间语言）

##### 运行机制

```
C# / VB.NET
   ↓ 编译
IL（MSIL / CIL）
   ↓ CLR + JIT
本地机器码
```

##### 逆向角度

托管代码：

- dnSpy / ILSpy 可直接反编译成 C#
- 函数名、类名、逻辑几乎完整
- 即使混淆，也比 native 好分析

### 非托管代码（Unmanaged Code）

##### 定义

不由 CLR 管理，直接运行在操作系统上的原生代码

典型语言：

- C / C++
- 汇编
- Rust（默认）
- Go（运行时自带，不是 CLR）

##### 运行机制

```
C / C++
   ↓ 编译
机器码（PE / ELF）
   ↓ OS Loader
CPU 执行
```

没有 CLR 参与

##### 逆向角度

- IDA / Ghidra / Binary Ninja
- 变量名、类型全没了
- 强依赖经验

### 托管 vs 非托管 对比表

| 对比项   | 托管代码   | 非托管代码 |
| -------- | ---------- | ---------- |
| 运行环境 | CLR        | 操作系统   |
| 编译结果 | IL         | 机器码     |
| 内存管理 | GC         | 手动       |
| 类型安全 | 是         | 否         |
| 指针操作 | 默认不允许 | 完全允许   |
| 逆向难度 | ⭐          | ⭐⭐⭐⭐       |
| 性能     | 中         | 高         |

### 托管代码调用非托管代码

##### C# 调用 C DLL

```
[DllImport("kernel32.dll")]
static extern IntPtr GetProcAddress(IntPtr hModule, string procName);
```

本质：

- 托管 → 非托管
- CLR 负责参数封送（Marshalling）

##### 安全/逆向重点

- 关键逻辑放在 native DLL
- 托管代码只是 loader
- dnSpy 里常见：

```c# 
[DllImport("xxx.dll")]
```

### 混合程序集（Mixed Mode）

使用 C++/CLI 可以写：

- 一部分托管
- 一部分非托管

特点：

- PE 同时包含：CLR Header、Native Code

**逆向时（重点，IDA 选择PE文件）：**

- **dnSpy + IDA 双开**

# 需要用到的工具

### ILSpy 

ILSpy 是一个开源的 .NET 程序反编译工具，用于将 .NET 程序（如 DLL 和 EXE 文件）反编译回源代码（通常为 C# 代码）。它支持 .NET Framework 和 .NET Core 的程序集，并能够解析和反编译其元数据、程序集代码、资源等内容。

下载地址：https://github.com/icsharpcode/ILSpy

### dnSpy

dnSpy 是一个开源的 .NET 反编译工具，广泛应用于 .NET 程序的调试、反编译、修改和重编译。它提供了比传统反编译工具（如 ILSpy）更强大的功能，特别是在调试和动态修改代码方面。dnSpy 适用于 .NET Framework 和 .NET Core 应用程序，支持 DLL、EXE 文件的反编译和源代码查看。

下载地址：https://github.com/dnSpy/dnSpy

### IDA

IDA（Interactive DisAssembler）是一款非常流行的反汇编工具，主要用于分析二进制文件和执行程序的内部结构，广泛应用于逆向工程、漏洞分析、安全研究等领域。IDA 提供了丰富的功能，包括反汇编、调试、分析符号、查看数据结构、跟踪程序执行流程等。

### Windbg

**能显示.net的调用栈**

WinDbg 是微软提供的一个强大的调试工具，主要用于调试 Windows 应用程序和内核级别的调试。它是 Windows 操作系统中非常重要的调试工具之一，广泛应用于软件开发、系统调试、漏洞分析、蓝屏死机分析等领域。