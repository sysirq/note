物理平台上的中断架构：首先，IO设备通过中断控制器发出中断请求，中断请求经由PCI总线发送到系统总线上，最后目标CPU的Local APIC部件接收中断，CPU开始处理中断。

在虚拟机的环境中，VMM也需要为客户机操作系统展现一个与物理中断架构类似的虚拟中断架构。虚拟Local APIC通过利用VT-x的事件注入机制将中断注入到相应的VCPU。

中断虚拟化的主要任务：虚拟PIC、虚拟IO APIC 和虚拟Local APIC，并且实现中断的生成、采集和注入的整个过程。

### 中断采集

来自于软件模拟的虚拟设备，直接调用虚拟IO APIC提供的接口向VCPU发送中断。

采集直接分配给客户机的物理设备发出的中断请求要复杂得多。物理中断需要首先由VMM的中断处理函数接收，再注入给客户机。

### 中断注入

中断注入负责将虚拟中断控制器采集到的中断请求按照其优先级，逐一注入客户机虚拟处理器中。

### 中断过程

CPU的INTR与中断控制器的INT相连，INTA与ACK相连，当一个外部中断发生时，中断控制器与CPU交互操作如下：

- IRQ1发生中断，主中断控制器收到中断信号，检查中断屏蔽寄存器IRQ1是否被屏蔽，如果屏蔽则忽略此中断信号
- 将中断控制器中的中断请求寄存器对应的IRQ1置位，表示收到IRQ1中断
- 中断控制器拉高INT引脚电平，通知CPU有中断发生
- CPU每执行完一条指令时，都会检查INTR引脚是否被拉高，这里已经被拉高
- CPU检查EFALGS寄存器的中断运行标识位IF是否位1，若为1，表明允许中断，通过INTA向中断控制器应答
- 中断控制器接收到应答信号，将IRQ1的中断向量发到数据总线上，此时CPPU通过数据总线读取到IRQ1的中断向量号
- 最后，如果中断控制器需要EOI信号，CPU则会发送，否则中断控制器自动将INT拉低，并清除IRQ1对应的中断请求寄存器位。

### 资料

KVM中断虚拟化浅析

https://www.cnblogs.com/ck1020/p/7424922.html