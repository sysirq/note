硬件虚拟化使用VCPU描述来描述虚拟CPU。VCPU描述符类似操作系统中进程描述符，本质是一个结构体，通常由下列几部分构成。

- VCPU标识信息：用于标识VCPU的一些属性，例如VCPU的ID号，VCPU属于那个客户机等。
- 虚拟寄存器信息：虚拟的寄存器资源，在使用Intel VT-x的情况下，这些内容包含在VMCS中，例如客户机状态域保存的内容。
- VCPU状态信息：类似进程的状态信息，标识该VCPU当前所处的状态，例如随眠、运行等，主要供调度器使用。
- 额外寄存器/部件信息：主要指包含在VMCS中的一些寄存器或CPU部件。
- 其他信息：用于VMM进行优化或存储额外信息的字段，例如存放该VCPU私有数据的指针等。

当VMM创建客户机时，首先要为客户机创建VCPU，整个客户机的运行实际上可以看作是VMM调度不同的VCPU运行。

### VCPU的创建

VCPU描述符包含的内容很多，通常会被组织成多级结构，例如第一级结构体可以是各个平台通用的内容，中间包含一个指针指向第二级结构体，包含平台相关的内容。

VCPU初始化：

- 分配VCPU标识符：首先要标识该VCPU属于哪个客户机，再为该VCPU分配一个在客户机范围内唯一的标识。
- 初始化虚拟寄存器组：主要初始化VMCS相关域
- 初始化VCPU状态信息：设置VCPU在被调度前需要配置的必要标志。
- 初始化额外部件
- 初始化其他信息

#### VMCS的创建与初始化

VMCS在分配时，只需要分配一块4KB大小，并对其到4KB边界的内存即可。

- 客户机状态域：设置成物理CPU加电后的状态
- 宿主机状态域：设置VMX Exit处理函数
- VM-Execution控制域：控制某些敏感指令是否发生VM-Exit
- VM-Entry控制域：这个状态域主要在每次VM-Entry之前设置，因此在VCPU初始化时不需要特别设置。
- VM-Exit控制域：这个状态域由两个字段VMM通常有兴趣去设置，一个是Acknowledge interrupt on exit，有助于更快地响应外部中断；另一个是Host Address Space，用于支持IA32e模式
- VM-Exit信息域：这个域的值由硬件自动更新，因此不需要初始化。

### VCPU的运行

上下文的切换也分为由硬件自动切换（VMCS部分）和VMM软件切换（非VMCS部分）两个部分。

- VMM保存自己的上下文，主要是保存VMCS不保存的寄存器，即宿主机状态域以外的部分
- VMM将保存在VCPU中的由软件切换的上下文加载到物理CPU。
- VMM执行VMRESUME/VMLAUNCH指令，触发VM-Entry，此时CPU自动将VCPU上下文中VMCS部分加载到物理CPU，CPU切换到根模式。

上下文切换次数频繁会带来不小的切换开销，因此对上下文切换进行优化是很有必要的。和操作系统一样，VMM也使用“惰性保存/恢复”的方法进行优化，其基本思想是尽量将寄存器的保存/恢复延迟到最后一刻，即其他VCPU或VMM需要用该寄存器的时候再保存/恢复。

### VCPU的退出

- 发生VM-Exit，CPU自动进行一部分上下文的切换。
- 当CPU切换到根模式开始执行VM-Exit的处理函数后，进行另一部分上下文的切换工作

VCPU退出的原因大体上有三类

- 访问了特权资源
- 客户机执行的指令引发了异常
- 发生了中断

### VCPU的再运行

