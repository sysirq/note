时钟的虚拟化关键是正确的模拟时钟中断。

- 绝对时间（Wall Time）:又称墙上时间。即操作系统启动后到目前为止的总运行时间，它是个单调递增的值。
- 相对时间：指两个时间之间的间隔。例如，两次时钟中断的间隔、两次使用RDTSC指令读取TSC间的间隔。

硬件定时器如RTC、PIT或者HPET等都能够以某种频率触发时钟中断，触发的频率可以由软件编程控制。

操作系统在启动的时候会读取CMOS的实时时钟，或通过NPT协议，得到系统启动时的绝对时间。同时，系统通过维护相对时间，可以知道系统总共运行的时间，从而操作系统可以得到任意时刻点的绝对时间，如下面的公式所示：

当前绝对时间=系统启动时的时间+系统启动后运行的时间

### 客户机的时间概念

大多数的应用都是像网络速度检测这样的应用，因此，通常时间虚拟化的策略都是给客户机呈现与实际时间相同的时间概念。

### 时钟设备仿真

x86系统中的时间设备包括PIT、HPET、ACPI PM Timer 和 TSC等。

PIT其功能主要是为操作系统提供定时的时钟中断和时钟计数器。操作系统通过对PIT设备的IO端口读写，设定时钟中断的触发频率，设置和读取时钟计数器。

假定客户机操作系统设定PIT时钟中断频率为10ms，VMM截获这一设定，并通知PIT设备模型。PIT设备模型会向VMM注册一个间隔为10ms的软件定时器，并提供回调函数，这个回调函数的功能就是向客户机注入一个时钟中断。

当客户机读取PIT的Counter寄存器时，PIT设备模型通过VMM了解当前的实际时间，并减去PIT的时间计数器被初始化时的实际时间，以得到这之间流逝的时间，经过PIT频率的转换后返回给客户机。

### 实现客户机时间概念的一种方法

通过由于将客户机调度出去，造成的时钟中断丢失重新注入来实现

### 实现客户机时间概念的另一种方法

客户机操作系统自动检查是否有丢失的时钟中断（记录两次时钟中断的间隔）