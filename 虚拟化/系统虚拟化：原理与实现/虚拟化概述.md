不论采用何种虚拟化方式，VMM对物理资源的虚拟化可以归结为三个主要任务：处理器虚拟化、内存虚拟化、IO虚拟化

# 可虚拟化架构与不可虚拟化架构

陷入再模拟敏感指令的执行来实现虚拟机的方法是有前提条件的：判断一个结构是否可虚拟化，其核心就在于该结构对敏感指令的支持上。如果在某些结构上所有敏感指令都是特权指令，则它是可虚拟化的结构。否则，如果它无法支持在所有的敏感指令上触发异常，则不是一个可虚拟化的结构，我们称其存中“虚拟化漏洞”。

也可以通过解释执行，来实现虚拟化，即取一条指令，模拟出这条指令执行的效果，在继续取下一条指令。但是该方法性能会大大下降。

既要填补虚拟化漏洞，又要保证虚拟化的性能，只能采取一些辅助的手段。或者直接在硬件层面填补虚拟化漏洞，或者通过软件的办法避免虚拟机中使用无法陷入的敏感指令。这些方法都不仅保证了敏感指令的执行都受到了VMM的监督审查，而且保证了非敏感指令可以不经过VMM而直接执行，从而相比完全解释执行来说，性能得到了极大的提高。

# 处理器虚拟化

处理器虚拟化是VMM中最核心的部分。

### 指令的模拟

当客户机操作系统试图访问关键资源的时候，该请求并不会真正发生在物理寄存器上。相反，VMM会通过准确模拟物理处理器的行为，而将其访问定位到VMM为其设计与物理寄存器对应的“虚拟”的寄存器上。当然，从VMM实现来说。这样的虚拟寄存器往往是在内存中。

VMM接管物理处理器后，客户机操作系统没有管理物理处理器的权利，可以说此时它已经运行在VMM为之设计的虚拟处理器之上。管理虚拟处理器，并在虚拟处理器上负责该虚拟机内进程间调度和切换。而VMM管理物理处理器，负责虚拟处理器的调度和切换，以保证在给定时间内，每个虚拟处理器上的当前进程可以在物理处理器上运行一段时间，切换时，需要保存虚拟处理器的上下文。

VMM陷入是利用了处理器的保护机制，利用中断和异常来完成的，它有以下几种方式。

- 基于处理器保护机制触发的异常，例如敏感指令的执行。
- 虚拟机主动触发异常
- 异步中断

### 中断和异常的模拟及注入

VMM通常会在硬件异常处理程序和指令模拟代码中进行异常虚拟化的检查。VMM需要区分两种原因：一是虚拟机自身对运行环境和上下文的设置违背了指令正确执行的条件；二是虚拟机运行在非高特权级别，由于虚拟化的原因触发的异常。

虚拟中断的触发来自于虚拟设备的模拟程序。

### 对称多处理器技术的模拟

通常，对称多处理器技术定义有标准的一套初始化过程。在没有虚拟化的环境里，BIOS负责选取BSP（主启动处理器）与AP（应用处理器），把所有处理器都初始化到某种状态后，BIOS在BSP上通过启动加载程序跳转至操作系统的初始化代码，同时所有的AP处于某种等待初始化硬件信号的状态。接下来，操作系统会初始化到某个时刻，发出某种初始化硬件信号给所有的AP，并提供一段特定的启动代码，AP在收到初始化硬件信号后，就会跳转到操作系统指定的启动代码中继续执行。通过这样一种方式，操作系统最终就成功地按自己地方式初始化了所有地处理器，最后在每个处理器上独立地运行调度程序。

# 内存虚拟化

内存虚拟化的核心，在于引入一层新地地址空间-----客户机物理地址空间。

由于引入了客户机物理地址空间，内存虚拟化就主要处理以下两个方面的问题。

- 给定一个虚拟机，维护客户机物理地址映射到宿主机物理地址之间的映射关系。
- 截获虚拟机对客户机物理地址的访问，并根据所记录的映射关系，将其转换成宿主机物理地址。

# IO虚拟化


# VMM的功能和组成