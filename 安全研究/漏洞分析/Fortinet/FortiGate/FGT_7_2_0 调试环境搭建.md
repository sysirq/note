# 环境搭建

### 创建log磁盘

```
qemu-img create -f qcow2 data.qcow2 30G
```

### 挂载qcow2 文件

```
sudo modprobe nbd max_part=8
sudo qemu-nbd --connect=/dev/nbd0 path_to_your.qcow2
sudo fdisk -l /dev/nbd0
sudo mount -o ro /dev/nbd0p1 /mnt/

sudo umount /mnt
sudo qemu-nbd --disconnect /dev/nbd0
```

### 内核解压

```
vmlinux-to-elf flatkc flatkc.elf
```

### rootfs

```
gzip -d rootfs.gz
cpio -id < rootfs
```

##### .tar.xz解压

```
sudo chroot . /sbin/xz --check=sha256 -d /bin.tar.xz
sudo chroot . /sbin/ftar -xf /bin.tar
sudo chroot . /sbin/xz --check=sha256 -d /migadmin.tar.xz
sudo chroot . /sbin/ftar -xf /migadmin.tar
sudo chroot . /sbin/xz --check=sha256 -d /usr.tar.xz
sudo chroot . /sbin/ftar -xf /usr.tar
sudo chroot . /sbin/xz --check=sha256 -d /node-scripts.tar.xz
sudo chroot . /sbin/ftar -xf /node-scripts.tar
```

### sbin/init 替换

```c
__int64 __fastcall main(__int64 a1, char **a2, char **a3)
{
  char *argv[4]; // [rsp+0h] [rbp-20h] BYREF

  argv[3] = (char *)__readfsqword(0x28u);
  sub_4017D0();//扫描/目录下所有文件，计算完整性，保存到/.fgtsum中
  unlink("/sbin/init.chk");
  if ( (int)sub_401AD0("bin") >= 0 && (int)sub_401AD0("migadmin") >= 0 && (int)sub_401AD0("node-scripts") >= 0 )
    sub_401AD0("usr");
  argv[0] = "/bin/init";
  argv[1] = 0LL;
  execve("/bin/init", argv, 0LL);
  return 0LL;
}
```


由于我们直接将bin.tar.xz、migadmin.tar.xz、usr.tar.xz、node-scripts.tar.xz 直接解压了的，不需要sbin/init中的解压逻辑，但是需要打开文件，以添加文件hash的逻辑，因此需要patch sbin/init ：

```c
void __fastcall main(int a1, char **a2, char **a3)
{
  char *argv[4]; // [rsp+0h] [rbp-20h] BYREF

  argv[3] = (char *)__readfsqword(0x28u);
  sub_401650();//添加文件hash逻辑保留，其他不要
  argv[0] = "/bin/init";
  argv[1] = 0LL;
  execve("/bin/init", argv, 0LL);
}
```

# 完整性检测

### 内核完整性检测

kernel_init --> init_post_isra_0 --> fgt_verify 会对/sbin/init进行完整性检查,需要将其返回0

```py
import idc
import idaapi
import idautils

data = idaapi.get_bytes(0xFFFFFFFF80803130, 10)
key = idaapi.get_bytes(0xFFFFFFFF8080324E, 4)

xor_result = bytes([byte ^ key[i % len(key)] for i, byte in enumerate(data)])

for b in xor_result:
    print(chr(b),end='')
```