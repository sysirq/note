# 虚拟机下载

地址：https://support.fortinet.com/Download/VMImages.aspx

Select Platform 我们选择 KVM

解压FGT_VM:

```sh
unzip FGT_VM64_KVM-v7.6.0.F-build3401-FORTINET.out.kvm.zip
```

创建log 磁盘：

```sh
qemu-img create -f qcow2 data.qcow2 30G
```

生成uuid：

```
sysirq@sysirq-machine:~/Work/Fortinet/FortiGate$ cat /proc/sys/kernel/random/uuid
e2d8d9d7-a25d-44be-93b5-97ffb52a51b0
```

虚拟机启动命令：

```bash
#/bin/bash

qemu-system-x86_64              -machine pc-i440fx-2.8 \
                                --accel kvm \
                                -m 2G \
                                -netdev tap,id=nc0,ifname=tap4fun,script=no,downscript=no \
                                -device virtio-net,netdev=nc0,mac=E0:35:0E:EE:A0:C0 \
                                -blockdev driver=file,node-name=hdafile,filename=fortios.qcow2 \
                                -blockdev driver=qcow2,file=hdafile,node-name=hda   \
                                -device virtio-blk,drive=hda  \
                                -blockdev driver=file,node-name=hdbfile,filename=data.qcow2 \
                                -blockdev driver=qcow2,file=hdbfile,node-name=hdb   \
                                -device virtio-blk,drive=hdb  \
                                -uuid e2d8d9d7-a25d-44be-93b5-97ffb52a51b0 \
                                -vnc 10.4.21.2:0

```

**Select Network to configure or add more network interfaces. The Device type must be Virtio.**

默认用户名：admin ， 密码为空

首次登录会要求你设置登录密码（方便期间，我设置为1234）

# 帮组信息获取

输入? , 可以获取命令提示。

输入特定命令后，在输入？，获取特定命令的帮助，eg: execute ?

# 网络配置

获取网卡信息：

```
get hardware nic port1
```

CLI 配置网络：

### 配置静态IP地址

```
config system interface
edit port1
set mode static
set ip 192.168.182.188 255.255.255.0
set allowaccess ping http https ssh
end
```

查看interfaces:

```
show system interface port1
```

### 配置默认路由

```
config router static
edit 1
set gateway 192.168.182.1
set device port1
end
```

查看路由配置：

```
show router static
```

### 配置DNS服务器

```
config system dns
set primary 8.8.8.8
set secondary 8.8.4.4
end
```

查看DNS配置

```
show system dns
```

之后，可以通过：192.168.182.188 访问Web管理页面，也可以通过ssh对其进行管理。

# 虚拟机永久试用许可证

版本：7.6.0

新部署的FortiGate-VM不再具有有效的评估许可证，即使该实例只有1个CPU和2 GB内存。执行命令get sys stat，输出结果如下:

```
Version: FortiGate-VM64-KVM v7.6.0,build3401,240724 (GA.F)
...
Serial-Number: FGVMEVNXFLTGKOBC
License Status: Invalid
VM Resources: 1 CPU/1 allowed, 2007 MB RAM/2048 MB allowed
```

从FortiCare获取虚拟机永久试用license:

```
execute vm-license-options account-id xxxx@fortinet.com
execute vm-license-options account-password xxxxxxx
execute vm-license
This VM is using the evaluation license. This license does not expire.
Limitations of the Evaluation VM license include:
  1.Support for low encryption operation only
  2.Maximum of 1 CPU and 2GiB of memory
  3.Maximum of three interfaces, firewall policies, and routes each
  4.No FortiCare Support
This operation will reboot the system !
Do you want to continue? (y/n)y

Connection to 192.168.182.188 closed.
```

激活后，可以通过https://support.fortinet.com/asset/#/dashboard 进行管理

# 命令行

- 输入**tree**显示整个FortiOS CLI命令树
- tree execute
- 可以使用grep提取特定信息，eg 提取网卡驱动：get hardware nic port1 | grep Driver 



### 排错命令

- diagnose hardware sysinfo vm full : 显示激活状态以及UUID
- get sys stat :   显示整体状态
  



### VM 通过 FortiGate VM上网

网络配置：

```sh
ip link add br4fgt type bridge
ip tuntap add dev tap4fgt_in mode tap
ip tuntap add dev tap4fgt_out mode tap
ip link set tap4fgt_in master br4fgt
ip link set tap4fgt_out master br4fgt
ip link set br4fgt up
ip link set tap4fgt_in up
ip link set tap4fgt_out up
```

VM启动脚本：

```sh
#/bin/bash

nohup qemu-system-x86_64 --accel kvm \
                    -m 8G \
                    -smp 4 \
                    -blockdev driver=file,filename=hd.qcow2,node-name=myfile \
                    -blockdev driver=qcow2,file=myfile,node-name=hd \
                    -device virtio-blk,drive=hd \
                    -netdev tap,id=nc0,ifname=tap4fgt_out,script=no,downscript=no \
                    -device virtio-net,netdev=nc0,mac=40:35:2E:EE:A0:C0 \
                    -device virtio-vga \
                    -device virtio-mouse \
                    -device virtio-keyboard \
                    -usbdevice  tablet \
                    -vnc 10.4.21.2:4 > qemu.log 2>&1 &
```

FortiGate VM 启动命令:

```sh
#/bin/bash

nohup qemu-system-x86_64 		-machine pc-i440fx-2.8 \
				--accel kvm \
				-m 2G \
				-netdev tap,id=nc0,ifname=tap4fun,script=no,downscript=no \
				-device virtio-net,netdev=nc0,mac=E0:35:0E:EE:A0:C0 \
				-netdev tap,id=nc1,ifname=tap4fgt_in,script=no,downscript=no \
				-device virtio-net,netdev=nc1,mac=E0:32:0E:EE:A0:C0 \
				-blockdev driver=file,node-name=hdafile,filename=fortios.qcow2 \
				-blockdev driver=qcow2,file=hdafile,node-name=hda   \
				-device virtio-blk,drive=hda  \
				-blockdev driver=file,node-name=hdbfile,filename=data.qcow2 \
				-blockdev driver=qcow2,file=hdbfile,node-name=hdb   \
				-device virtio-blk,drive=hdb  \
				-uuid e2d8d9d7-a25d-44be-93b5-97ffb52a51b0 \
				-vnc 10.4.21.2:0 > qemu.log 2>&1 &
```



FortiGate 配置，参考资料中的：虚拟 PC 通过 FortiGate VM 上网



# 挂载QCOW2文件

FGT KVM版本：7.6.0

```
sudo modprobe nbd max_part=8
sudo qemu-nbd --connect=/dev/nbd0 path_to_your.qcow2
sudo fdisk -l /dev/nbd0
sudo mount -o ro /dev/nbd0p1 /mnt/

sudo umount /mnt
sudo qemu-nbd --disconnect /dev/nbd0
```

### 内核解压

下载 vmlinux-to-elf ( https://github.com/marin-m/vmlinux-to-elf )，

```
sysirq@sysirq-machine:~/Work/Fortinet/Tmp/data$ file flatkc
flatkc: Linux kernel x86 boot executable bzImage, version 4.19.13 (root@build) #1 SMP Wed Jul 24 17:24:03 UTC 2024, RO-rootFS, swap_dev 0X7, Normal VGA
```

```
vmlinux-to-elf flatkc flatkc.elf
```

### rootfs解压

查看extlinux.conf

```
sysirq@sysirq-machine:~/Work/Fortinet/Tmp/data$ cat extlinux.conf
DISPLAY boot.msg
TIMEOUT 10
TOTALTIMEOUT 9000
DEFAULT flatkc ro panic=5 endbase=0xA0000 console=ttyS0, root=/dev/ram0 ramdisk_size=65536 initrd=/rootfs.gz
```

可以看到rootfs.gz作为initrd临时根文件系统。在内核中的对其进行处理的函数为：/init/initramfs.c:populate_rootfs函数

populate_rootfs 函数是 Linux 内核启动过程中的一个关键函数，用于设置和填充初始的根文件系统。它主要负责处理 initramfs 和 initrd，并确保它们被正确地挂载和初始化。

```c
rootfs_initcall(populate_rootfs);

#define rootfs_initcall(fn)		__define_initcall(fn, rootfs)

#define __define_initcall(fn, id) \
	static initcall_t __initcall_##fn##id __used \
	__attribute__((__section__(".initcall" #id ".init"))) = fn;
```

/include/asm-generic/vmlinux.lds.h：

```c
#define INIT_CALLS							\
		VMLINUX_SYMBOL(__initcall_start) = .;			\
		KEEP(*(.initcallearly.init))				\
		INIT_CALLS_LEVEL(0)					\
		INIT_CALLS_LEVEL(1)					\
		INIT_CALLS_LEVEL(2)					\
		INIT_CALLS_LEVEL(3)					\
		INIT_CALLS_LEVEL(4)					\
		INIT_CALLS_LEVEL(5)					\
		INIT_CALLS_LEVEL(rootfs)				\
		INIT_CALLS_LEVEL(6)					\
		INIT_CALLS_LEVEL(7)					\
		VMLINUX_SYMBOL(__initcall_end) = .;
```

populate_rootfs的调用流程为: start_kernel --> rest_init--> kernel_init --> kernel_init_freeable --> do_basic_setup --> do_initcalls  --> populate_rootfs

# 资料

Configuring Network Settings using the CLI

https://help.fortinet.com/fdb/5-0-0/html/source/tasks/t_network_configuration_cli.html

Administration Guide

https://docs.fortinet.com/document/fortigate/7.4.4/administration-guide/498634/using-the-cli

Permanent trial mode for FortiGate-VM

https://docs.fortinet.com/document/fortigate/7.4.4/administration-guide/441460

KVM Administration Guide

https://docs.fortinet.com/document/fortigate-private-cloud/7.4.0/kvm-administration-guide/706376/about-fortigate-vm-on-kvm

Error downloading license: Invalid serial number

https://community.fortinet.com/t5/Support-Forum/Error-downloading-license-Invalid-serial-number/m-p/251838

Technical Note: VM License activation

https://community.fortinet.com/t5/FortiGate/Technical-Note-VM-License-activation/ta-p/190534

VM license

https://docs.fortinet.com/document/fortigate/7.4.4/administration-guide/416169

虚拟 PC 通过 FortiGate VM 上网

https://blog.csdn.net/meigang2012/article/details/105269399

FORTIGATE FIRMWARE ANALYSIS

https://www.optistream.io/blogs/tech/fortigate-firmware-analysis

Further Adventures in Fortinet Decryption

https://bishopfox.com/blog/further-adventures-in-fortinet-decryption