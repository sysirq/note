# 环境搭建

版本下载：FGT_VM64_KVM-v7.2.8.M

```
config system settings
    set gui-sslvpn enable
end

config system global
    set sslvpn-web-mode enable
end
```

### initrd 解压分析

```c
unsigned __int64 fgt_verify_decrypt()
{
  __int64 v0; // r12
  unsigned int v1; // r13d
  _DWORD *v2; // rsi
  char *v3; // rdi
  __int64 i; // rcx
  char v6[32]; // [rsp+0h] [rbp-78h] BYREF
  char v7[64]; // [rsp+20h] [rbp-58h] BYREF
  unsigned __int64 v8; // [rsp+60h] [rbp-18h]

  v8 = __readgsqword(0x28u);
  v0 = initrd_start;
  v1 = initrd_end - initrd_start;
  v2 = &unk_FFFFFFFF817951C0;//key：b"\x88\xa3\x8c\x08t;\xcc\xcb*h\xb4\xac\x0f5\x0f\x14j\xd9K\x00\xba'\n\xdd!\xce\xa4z\x10&\xe8W"
  v3 = v6;
  for ( i = 8LL; i; --i )
  {
    *(_DWORD *)v3 = *v2++;
    v3 += 4;
  }
  crypto_chacha20_init(v7, v6, &unk_FFFFFFFF817951E0);//unk_FFFFFFFF817951E0 iv ：b'\x9f\x00\xfe\xf5\xb5\xfd\x9b]=1\xa5\xe6\xf5\xf3\x8c\x9c'
  chacha20_docrypt(v7, v0, v0, v1);
  return v8 - __readgsqword(0x28u);
}
```

通过initrd_start 以及 initrd_end 变量 ， 找到fgt_verify_decrypt 解密initrd的函数。

initrd解密代码

```python
#!/usr/bin/python3
import hashlib
import os
import rsa
import sys
import binascii
import hashlib
import struct
from Crypto.Cipher import ChaCha20

initrd_name="rootfs.gz"
output_initrd_name="rootfs.gz.out"

key = b"\x88\xa3\x8c\x08t;\xcc\xcb*h\xb4\xac\x0f5\x0f\x14j\xd9K\x00\xba'\n\xdd!\xce\xa4z\x10&\xe8W"
iv  = b'\x9f\x00\xfe\xf5\xb5\xfd\x9b]=1\xa5\xe6\xf5\xf3\x8c\x9c'

file_size = os.path.getsize(initrd_name)
file_content = open(initrd_name,'rb').read(file_size - 256)

chacha=ChaCha20.new(key=key, nonce=iv[4:])
counter=int.from_bytes(iv[:4],'little')
chacha.seek(counter*64)

decrypt_initrd_data = chacha.decrypt(file_content)

open(output_initrd_name,'wb').write(decrypt_initrd_data)
```



initrd解密代码:

```
#!/usr/bin/python3
import hashlib
import os
import rsa
import sys
import binascii
import hashlib
import struct
from Crypto.Cipher import ChaCha20

initrd_to_encrypt_name="initrd.cpio.gz" # 需要进行加密的initrd
output_initrd_name="rootfs.encrypt.gz.out" # 加密后的initrd

key = b"\x88\xa3\x8c\x08t;\xcc\xcb*h\xb4\xac\x0f5\x0f\x14j\xd9K\x00\xba'\n\xdd!\xce\xa4z\x10&\xe8W"
iv  = b'\x9f\x00\xfe\xf5\xb5\xfd\x9b]=1\xa5\xe6\xf5\xf3\x8c\x9c'

file_size = os.path.getsize(initrd_to_encrypt_name)
file_content = open(initrd_to_encrypt_name,'rb').read(file_size)

chacha=ChaCha20.new(key=key, nonce=iv[4:])
counter=int.from_bytes(iv[:4],'little')
chacha.seek(counter*64)

encrypt_initrd_data = chacha.encrypt(file_content) + b'\x00'*256

open(output_initrd_name,'wb').write(encrypt_initrd_data)
```

### IMA机制分析

### patch 

- 内核patch：需要 fgt_verify_initrd ，防止machine_halt
- init patch : patch点位没变，参考调试环境那篇

### rootfs

##### .tar.xz解压

```
sudo chroot . /sbin/xz --check=sha256 -d /bin.tar.xz
sudo chroot . /sbin/ftar -xf /bin.tar
sudo chroot . /sbin/xz --check=sha256 -d /migadmin.tar.xz
sudo chroot . /sbin/ftar -xf /migadmin.tar
sudo chroot . /sbin/xz --check=sha256 -d /usr.tar.xz
sudo chroot . /sbin/ftar -xf /usr.tar
sudo chroot . /sbin/xz --check=sha256 -d /node-scripts.tar.xz
sudo chroot . /sbin/ftar -xf /node-scripts.tar
```

# 参考资料

CVE-2022-42475 FortiGate SSLVPN 堆溢出漏洞分析与利用

https://forum.butian.net/share/2166

Fortinet Series 2 — Analysis of SSLVPN exploit (CVE-2022–42475)

https://medium.com/@INTfinitySG/fortinet-series-2-analysis-of-sslvpn-exploit-cve-2022-42475-5c45ff9505ef

7.6.0 SSL VPN

https://docs.fortinet.com/document/fortigate/7.6.0/administration-guide/371626/ssl-vpn

Attacking SSL VPN - Part 2: Breaking the Fortigate SSL VPN

https://devco.re/blog/2019/08/09/attacking-ssl-vpn-part-2-breaking-the-Fortigate-ssl-vpn/