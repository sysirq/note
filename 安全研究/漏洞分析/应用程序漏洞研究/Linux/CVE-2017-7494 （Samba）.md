# 漏洞介绍
samba 是在Linux系统上实现SMB协议的一个免费软件。用于在局域网上共享打印机与文件。在版本Samba 3.5.0 之后到4.6.4/4.5.10/4.4.14中间的所有版本存在一个漏洞，允许攻击者上传自己的动态库到可写的samba目录中，从而导致任意代码执行。

# 漏洞分析
由于当客户端请求为文件创建命名管道时，服务端会执行到漏洞函数:

```c
//source3/rpc_server/srv_pipe.c

bool is_known_pipename(const char *pipename, struct ndr_syntax_id *syntax)
{
	NTSTATUS status;

	if (lp_disable_spoolss() && strequal(pipename, "spoolss")) {
		DEBUG(10, ("refusing spoolss access\n"));
		return false;
	}

	if (rpc_srv_get_pipe_interface_by_cli_name(pipename, syntax)) {
		return true;
	}

	status = smb_probe_module("rpc", pipename); //(1)
	if (!NT_STATUS_IS_OK(status)) {
		DEBUG(10, ("is_known_pipename: %s unknown\n", pipename));
		return false;
	}
	DEBUG(10, ("is_known_pipename: %s loaded dynamically\n", pipename));

	/*
	 * Scan the list again for the interface id
	 */
	if (rpc_srv_get_pipe_interface_by_cli_name(pipename, syntax)) {
		return true;
	}

	DEBUG(10, ("is_known_pipename: pipe %s did not register itself!\n",
		   pipename));

	return false;
}
``` 
在语句(1)处，会调用smb_probe_module,该函数调用do_smb_load_module函数。

do_smb_load_module 函数会加载pipename为名称的动态链接库，并获得以samba_init_module命名的函数，然后执行。

若我们能够将恶意动态链接库上传至smb服务器，然后猜测该动态链接库在服务端的绝对路径地址，再请求为动态库创建命名管道，则可以执行攻击。

# 环境搭建
    软件版本：samba 4.5.9 (https://download.samba.org/pub/samba/stable/)

    系统版本：CentOS 7 64位
    
    (提示:  注意关掉防火墙，不然无法访问)

    
# 参考质料

1. https://klionsec.github.io/2017/04/25/samba-rce/ (环境搭建)
2. https://www.cnblogs.com/jiqingwu/p/linux_dynamic_lib_create.html (动态链接库创建)
3. https://yaofeifly.github.io/2017/08/28/Samba/ (分析报告)
4. http://www.cnblogs.com/LittleHann/p/6916326.html (SMB协议介绍)
5. https://www.exploit-db.com/exploits/42060/ (exp)