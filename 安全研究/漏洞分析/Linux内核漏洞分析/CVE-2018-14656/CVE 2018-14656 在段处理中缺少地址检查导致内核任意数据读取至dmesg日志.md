# 描述

Linux内核中，show_opcodes()即用于转储内核指令，也用于转储用户指令。如果用户空间通过跳转到内核地址导致Page fault，由于show_opcodes()缺少地址检查，导致可以dump任意内核地址处的数据到dmesg日志中

# 漏洞分析环境

Linux内核版本:4.18.0

体系结构：x86_64

发行版: Ubuntu 14.04

# 分析

show_opcodes函数流程:

![called By - show_opcodes](./images/called%20By%20-%20show_opcodes.png)


可以看到,show_opcodes有两个调用流程:
- show_signal_msg()：当用户空间出现段错误时，显示用户空间指令
- show_ip()：当内核检查到某种bug时，会调用，这意味着要触发它，至少需要触发一个WARN()

对于第一种的演示:

![first variant - stage 1](./images/first%20variant%20-%20stage%201.png)

![first variant - stage 2](./images/first%20variant%20-%20stage%202.png)

![first variant - stage 3](./images/first%20variant%20-%20stage%203.png)

可以看到:

```
<4c> 69 6e 75 78 20 76 65 72 73 69 6f 6e 20 34 2e 31 38 2e 30 20 28
```

翻译成ASCII码：

```
Linux version 4.18.0 (
```

可以看到成功将内核中的linux_banner内容展示了出来


打印调用栈：

![first variant analyze - stage 1](./images/first%20variant%20analyze%20-%20stage%201.png)

当触发page fault时，__do_page_fault判断地址是处于内核空间的，其会调用 bad_area_nosemaphore，进而调用show_opcodes,其将引起page fault处的周围指令转储到dmesg日志中。

第二种可以参考资料3.

# 影响版本

ba54d856a9d8和7cccf0725cf7引入的上游Linux内核。自v4.18-rc1起，到v4.19-rc2后由342db04ae712修复

# 参考资料

1.https://bugzilla.redhat.com/show_bug.cgi?id=1629940

2.https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=342db04ae71273322f0011384a9ed414df8bdae4

3.https://bugs.chromium.org/p/project-zero/issues/detail?id=1650