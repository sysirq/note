# boot.pl

```perl
if (!DSSys::isProductZTA()) {
    DSSafe::system3 ("$dsinstall/bin/unzip", "$dsinstall/venv3/lib/python3.6/site-packages/scanner-0.1-py3.6.egg", "-d", "/tmp", ">/dev/null", "2>&1");
    if (-e "/tmp/scanner") {
        DSLog::Msg("boot", 30, "Starting system integrity scan");
        my $res = DSSafe::system("$dsinstall/venv3/bin/python /tmp/scanner/driver/scanmgr.py");
        my $checkbox = DSUtilConfig::getConfigValue("HOST_MANIFEST_INTEGRITY_VALIDATION");
        if ($checkbox eq "on") {
            my $exit_code = $res / 256;
            DSLog::Msg("boot", 30, "Manifest integrity validation checkbox value=$checkbox and ICT exit code=$exit_code");
            if ($exit_code != 0) {
                DSLog::Msg("boot", 10, "interrupting the system boot as Integrity Validation Failed");
                printAndLog("Interrupting the system boot as Integrity Validation Failed");

                #get ict snapshot file path from cache
                my $pathStrFromCache = "";
                my $ci_path = DSCacheItem->new("integrity_checker", "snapshot_path");
                $ci_path->getStr($pathStrFromCache);
                
                DSLog::Msg("boot", 10, "boot time ICT:: snapshot filepath from cache [$pathStrFromCache]");


                if( scpHelper($pathStrFromCache) == 0) {
                    DSLog::Msg("boot", 10, "boot time ICT:: clearning cache as SCP is succesfull");
                    #clear the snapshot path from cache
                    my $change = new DSCacheChanges();
                    $change->updateStr($ci_path, "");
                    $change->commit();
                }

       CHOICE:
                #check for rollback or factory reset
                my $ver = checkRollbackOrFactoryReset();

                my $secOption = "";
                if ($ver eq ROLLBACK) {
                    $secOption = "Rollback";
                } elsif($ver eq FACTORYRESET) {
                    $secOption = "Factory Reset";    
                } 

                my $msg = "\nSelect the appropriate action:";
                $msg .= "\nWarning: Opting for 'Continue to boot' may result in non-compliance with CCN Certification. The Compliance GUI checkbox will be disabled. You can re-enable it by navigating to Configuration>Security>Miscellaneous page.";
                $msg .= "\n1. Reboot";
                $msg .= "\t2. $secOption";
                $msg .= "\t3. Continue to boot";
                print $msg;

                my $choice = &DSReadLine::readline("\nChoice: ");
                chomp($choice); # remove trailing newline
                $choice =~ s/^\s+|\s+$//g; # remove leading and trailing whitespaces

                if($choice eq 1) {
                    DSLog::Msg("boot", 0, "boot time ICT:: Reboot option selected");
                    exit(2);
                } elsif ($choice eq 2) {
                    if($ver eq ROLLBACK) {
                        DSLog::Msg("boot", 0, "boot time ICT:: Rollback option selected");
                        exit(3);    
                    } elsif ($ver eq FACTORYRESET) {
                        DSLog::Msg("boot", 0, "boot time ICT:: Factory reset option selected");
                        exit(4);    
                    }
                } elsif($choice eq 3) {
                    DSLog::Msg("boot", 10, "boot time ICT:: Continue to boot option selected");
                    DSUtilConfig::setConfigValue("HOST_MANIFEST_INTEGRITY_VALIDATION", "off");
                } else {
                    #Invalid option selected  
                    printAndLog("\nInvalid option selected, please try again.");
                    goto CHOICE;  
                }
            }
        }
    }
}

```

