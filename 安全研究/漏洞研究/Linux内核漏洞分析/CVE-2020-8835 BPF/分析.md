# eBPF介绍

eBPF是extended Berkeley Packet Filter的缩写。起初是用于捕获和过滤特定规则的网络数据包,现在也被用在防火墙，安全，内核调试与性能分析等领域。

eBPF程序的运行过程如下：在用户空间生产eBPF“字节码”，然后将“字节码”加载进内核中的“虚拟机”中，然后进行一些列检查，通过则能够在内核中执行这些“字节码”。类似Java与JVM虚拟机，但是这里的虚拟机是在内核中的。

# 内核中的eBPF验证程序

允许用户代码在内核中运行存在一定的安全性。因此，在加载每个eBPF程序之前，都要执行许多检查。

首先确保eBPF程序能正常终止，不包含任何可能导致内核锁定的循环。这是通过对程序的控制流图(CFG)进行深度优先搜索来实现的。包含无法访问的指令的eBPF程序,将无法加载。

第二需要内核验证器（verifier ），模拟eBPF程序的执行，模拟通过后才能正常加载。在执行每条指令之前和之后，都需要检查虚拟机状态，以确保寄存器和堆栈状态是有效的。禁止越界跳转，也禁止访问非法数据。

验证器不需要遍历程序中的每条路径，它足够聪明，可以知道程序的当前状态何时是已经检查过的状态的子集。由于所有先前的路径都必须有效（否则程序将无法加载），因此当前路径也必须有效。 这允许验证器“修剪”当前分支并跳过其仿真。

其次具有未初始化数据的寄存器无法读取；这样做会导致程序加载失败。

最后，验证器使用eBPF程序类型来限制可以从eBPF程序中调用哪些内核函数以及可以访问哪些数据结构。

# 环境搭建

我使用的虚拟机为VMware 15，发行版为Linux Mint 19.3 Tricia。

```bash
➜  kernel git clone git://git.kernel.org/pub/scm/linux/kernel/git/bpf/bpf-next.git
➜  kernel cd bpf-next/ 
➜  bpf-next git:(master) git reset --hard 581738a681b6
Checking out files: 100% (18888/18888), done.
HEAD is now at 581738a681b6 bpf: Provide better register bounds after jmp32 instructions
```

发现内核为5.4.0-rc8。

然后是简单的内核编译安装了，网上资料一大堆。

但要注意的是要打开BPF的编译选项：

```
Networking support > Networking options > [*] enable BPF Just In Time compiler

General setup > [*] Enable bpf() system call 和子选项 [*]   Permanently enable BPF JIT and remove BPF interpreter

Networking support > Networking options > [*] BPF based packet filtering framework (BPFILTER)  
```

我编译的是带调试符号的内核。

然后就是重启，选择我们刚刚编译好的内核了。

```bash
➜  ~ uname -a
Linux john-virtual-machine 5.4.0-rc8+ #1 SMP Wed Apr 1 14:19:14 CST 2020 x86_64 x86_64 x86_64 GNU/Linux
```

# 漏洞分析

漏洞所在函数是__reg_bound_offset32，位于kernel/bpf/verifier.c:1010，错误的mask计算而导致的漏洞。

# 资料

A thorough introduction to eBPF

https://lwn.net/Articles/740157/

CVE-2020-8835: Linux kernel bpf incorrect verifier vulnerability

https://www.openwall.com/lists/oss-security/2020/03/30/3

get-rekt-linux-hardened.c

https://github.com/brl/grlh/blob/master/get-rekt-linux-hardened.c

bpf-docs

https://github.com/iovisor/bpf-docs/blob/master/eBPF.md

KERNEL PWN状态切换原理及KPTI绕过

https://bbs.pediy.com/thread-258975.htm